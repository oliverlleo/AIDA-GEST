# Security Hardening Post-Migration (After)
## Routine Grants (After)
```json
Status: 201
Response: [{"routine_name":"can_manage_logo","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"create_employee","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"create_owner_workspace_and_profile","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"current_employee_from_token","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"current_employee_from_token","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"employee_change_password","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"employee_login","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"employee_logout","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"get_client_ticket_details_public","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"get_client_ticket_details_public","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"get_dashboard_kpis","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"get_dashboard_kpis","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"get_employees_for_workspace","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"get_employees_for_workspace","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"get_operational_alerts","grantee":"anon","privilege_type":"EXECUTE"},{"routine_name":"get_operational_alerts","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"log_ticket_changes","grantee":"PUBLIC","privilege_type":"EXECUTE"},{"routine_name":"reset_employee_password","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"update_employee","grantee":"authenticated","privilege_type":"EXECUTE"},{"routine_name":"validate_employee_session","grantee":"anon","privilege_type":"EXECUTE"}]
```
## Table Grants (After)
```json
Status: 201
Response: [{"table_name":"checklist_templates","grantee":"anon","privilege_type":"SELECT"},{"table_name":"checklist_templates","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"checklist_templates","grantee":"anon","privilege_type":"INSERT"},{"table_name":"checklist_templates","grantee":"anon","privilege_type":"DELETE"},{"table_name":"checklist_templates","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"checklist_templates","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"checklist_templates","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"checklist_templates","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"defect_options","grantee":"anon","privilege_type":"INSERT"},{"table_name":"defect_options","grantee":"anon","privilege_type":"DELETE"},{"table_name":"defect_options","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"defect_options","grantee":"anon","privilege_type":"SELECT"},{"table_name":"defect_options","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"defect_options","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"defect_options","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"defect_options","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"defects","grantee":"anon","privilege_type":"INSERT"},{"table_name":"defects","grantee":"anon","privilege_type":"DELETE"},{"table_name":"defects","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"defects","grantee":"anon","privilege_type":"SELECT"},{"table_name":"defects","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"defects","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"defects","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"defects","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"device_models","grantee":"anon","privilege_type":"INSERT"},{"table_name":"device_models","grantee":"anon","privilege_type":"DELETE"},{"table_name":"device_models","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"device_models","grantee":"anon","privilege_type":"SELECT"},{"table_name":"device_models","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"device_models","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"device_models","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"device_models","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"employees","grantee":"anon","privilege_type":"INSERT"},{"table_name":"employees","grantee":"anon","privilege_type":"SELECT"},{"table_name":"employees","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"employees","grantee":"anon","privilege_type":"DELETE"},{"table_name":"employees","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"employees","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"employees","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"employees","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"internal_notes","grantee":"anon","privilege_type":"DELETE"},{"table_name":"internal_notes","grantee":"anon","privilege_type":"INSERT"},{"table_name":"internal_notes","grantee":"anon","privilege_type":"SELECT"},{"table_name":"internal_notes","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"internal_notes","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"internal_notes","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"internal_notes","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"internal_notes","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"notifications","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"notifications","grantee":"anon","privilege_type":"DELETE"},{"table_name":"notifications","grantee":"anon","privilege_type":"SELECT"},{"table_name":"notifications","grantee":"anon","privilege_type":"INSERT"},{"table_name":"notifications","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"notifications","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"notifications","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"notifications","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"outsourced_companies","grantee":"anon","privilege_type":"INSERT"},{"table_name":"outsourced_companies","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"outsourced_companies","grantee":"anon","privilege_type":"SELECT"},{"table_name":"outsourced_companies","grantee":"anon","privilege_type":"DELETE"},{"table_name":"outsourced_companies","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"outsourced_companies","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"outsourced_companies","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"outsourced_companies","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"profiles","grantee":"anon","privilege_type":"INSERT"},{"table_name":"profiles","grantee":"anon","privilege_type":"DELETE"},{"table_name":"profiles","grantee":"anon","privilege_type":"SELECT"},{"table_name":"profiles","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"profiles","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"profiles","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"profiles","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"profiles","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"suppliers","grantee":"anon","privilege_type":"INSERT"},{"table_name":"suppliers","grantee":"anon","privilege_type":"DELETE"},{"table_name":"suppliers","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"suppliers","grantee":"anon","privilege_type":"SELECT"},{"table_name":"suppliers","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"suppliers","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"suppliers","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"suppliers","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"terceirizados","grantee":"anon","privilege_type":"SELECT"},{"table_name":"terceirizados","grantee":"anon","privilege_type":"DELETE"},{"table_name":"terceirizados","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"terceirizados","grantee":"anon","privilege_type":"INSERT"},{"table_name":"terceirizados","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"terceirizados","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"terceirizados","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"terceirizados","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"ticket_logs","grantee":"anon","privilege_type":"DELETE"},{"table_name":"ticket_logs","grantee":"anon","privilege_type":"INSERT"},{"table_name":"ticket_logs","grantee":"anon","privilege_type":"SELECT"},{"table_name":"ticket_logs","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"ticket_logs","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"ticket_logs","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"ticket_logs","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"ticket_logs","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"tickets","grantee":"anon","privilege_type":"INSERT"},{"table_name":"tickets","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"tickets","grantee":"anon","privilege_type":"SELECT"},{"table_name":"tickets","grantee":"anon","privilege_type":"DELETE"},{"table_name":"tickets","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"tickets","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"tickets","grantee":"authenticated","privilege_type":"SELECT"},{"table_name":"tickets","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"workspaces","grantee":"anon","privilege_type":"DELETE"},{"table_name":"workspaces","grantee":"anon","privilege_type":"INSERT"},{"table_name":"workspaces","grantee":"anon","privilege_type":"SELECT"},{"table_name":"workspaces","grantee":"anon","privilege_type":"UPDATE"},{"table_name":"workspaces","grantee":"authenticated","privilege_type":"INSERT"},{"table_name":"workspaces","grantee":"authenticated","privilege_type":"DELETE"},{"table_name":"workspaces","grantee":"authenticated","privilege_type":"UPDATE"},{"table_name":"workspaces","grantee":"authenticated","privilege_type":"SELECT"}]
```
## Security Definer Audit (After)
```json
Status: 201
Response: []
```
## Storage Policies (After)
```json
Status: 201
Response: [{"policyname":"Logos Public Read","cmd":"SELECT","roles":"{public}","qual":"(bucket_id = 'workspace_logos'::text)","with_check":null},{"policyname":"fp_logos_auth_delete","cmd":"DELETE","roles":"{authenticated}","qual":"((bucket_id = 'workspace_logos'::text) AND can_manage_logo(name))","with_check":null},{"policyname":"fp_logos_auth_insert","cmd":"INSERT","roles":"{authenticated}","qual":null,"with_check":"((bucket_id = 'workspace_logos'::text) AND can_manage_logo(name))"},{"policyname":"fp_logos_auth_update","cmd":"UPDATE","roles":"{authenticated}","qual":"((bucket_id = 'workspace_logos'::text) AND can_manage_logo(name))","with_check":null},{"policyname":"fp_ticket_photos_anon_delete","cmd":"DELETE","roles":"{anon}","qual":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] = ( SELECT (current_employee_from_token.workspace_id)::text AS workspace_id\n   FROM current_employee_from_token() current_employee_from_token(employee_id, workspace_id, role))))","with_check":null},{"policyname":"fp_ticket_photos_anon_insert","cmd":"INSERT","roles":"{anon}","qual":null,"with_check":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] = ( SELECT (current_employee_from_token.workspace_id)::text AS workspace_id\n   FROM current_employee_from_token() current_employee_from_token(employee_id, workspace_id, role))))"},{"policyname":"fp_ticket_photos_anon_select","cmd":"SELECT","roles":"{anon}","qual":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] = ( SELECT (current_employee_from_token.workspace_id)::text AS workspace_id\n   FROM current_employee_from_token() current_employee_from_token(employee_id, workspace_id, role))))","with_check":null},{"policyname":"fp_ticket_photos_anon_update","cmd":"UPDATE","roles":"{anon}","qual":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] = ( SELECT (current_employee_from_token.workspace_id)::text AS workspace_id\n   FROM current_employee_from_token() current_employee_from_token(employee_id, workspace_id, role))))","with_check":null},{"policyname":"fp_ticket_photos_auth_delete","cmd":"DELETE","roles":"{authenticated}","qual":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] IN ( SELECT (profiles.workspace_id)::text AS workspace_id\n   FROM profiles\n  WHERE (profiles.id = auth.uid()))))","with_check":null},{"policyname":"fp_ticket_photos_auth_insert","cmd":"INSERT","roles":"{authenticated}","qual":null,"with_check":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] IN ( SELECT (profiles.workspace_id)::text AS workspace_id\n   FROM profiles\n  WHERE (profiles.id = auth.uid()))))"},{"policyname":"fp_ticket_photos_auth_select","cmd":"SELECT","roles":"{authenticated}","qual":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] IN ( SELECT (profiles.workspace_id)::text AS workspace_id\n   FROM profiles\n  WHERE (profiles.id = auth.uid()))))","with_check":null},{"policyname":"fp_ticket_photos_auth_update","cmd":"UPDATE","roles":"{authenticated}","qual":"((bucket_id = 'ticket_photos'::text) AND ((storage.foldername(name))[1] IN ( SELECT (profiles.workspace_id)::text AS workspace_id\n   FROM profiles\n  WHERE (profiles.id = auth.uid()))))","with_check":null}]
```

## Allowlist Documentation

| Function | Signature | Roles | Justification | Source |
|---|---|---|---|---|
| `can_manage_logo` | `(text)` | `authenticated` | Used by storage policy for logo management | Storage Policy `Logos Secure *` |
| `create_employee` | `(uuid,text,text,text,text[])` | `authenticated` | Admin creates employee | `js/main.js` |
| `create_owner_workspace_and_profile` | `(text,text)` | `authenticated` | Admin Signup/Init | `js/main.js` |
| `current_employee_from_token` | `()` | `anon`, `authenticated` | Derives workspace from token, used in policies | RLS/Storage Policies |
| `employee_change_password` | `(uuid,text,text)` | `anon` | Employee changes own password | `js/main.js` |
| `employee_login` | `(text,text,text)` | `anon` | Employee Login | `js/main.js` |
| `employee_logout` | `(uuid)` | `anon` | Employee Logout | `js/main.js` |
| `get_client_ticket_details_public` | `(uuid,uuid)` | `anon`, `authenticated` | Public tracking page | `acompanhar.html` |
| `get_dashboard_kpis` | `(date,date,uuid,text,text,text,text)` | `anon`, `authenticated` | Dashboard Metrics | `js/main.js` |
| `get_employees_for_workspace` | `(uuid)` | `anon`, `authenticated` | Employee List (Admin & Tech Bench) | `js/main.js` |
| `get_operational_alerts` | `(uuid)` | `anon`, `authenticated` | Operational Dashboard Alerts | `js/main.js` |
| `reset_employee_password` | `(uuid,text)` | `authenticated` | Admin resets employee password | `js/main.js` |
| `update_employee` | `(uuid,text,text,text,text[])` | `authenticated` | Admin updates employee | `js/main.js` |
| `validate_employee_session` | `(uuid)` | `anon` | Session validation on load | `js/main.js` |
