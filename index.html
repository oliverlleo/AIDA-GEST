<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssist - Gestão Inteligente</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#FF6B00', // Laranja
                            600: '#E65100',
                            900: '#1a1a1a', // Preto suave
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3/dist/cdn.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar for Kanban */
        .kanban-col::-webkit-scrollbar { width: 4px; }
        .kanban-col::-webkit-scrollbar-thumb { background: #CBD5E0; border-radius: 4px; }
        .kanban-col:hover::-webkit-scrollbar-thumb { background: #A0AEC0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 antialiased" x-data="app()">

    <!-- Loading Overlay -->
    <div x-show="loading" class="fixed inset-0 bg-white z-[99] flex items-center justify-center bg-opacity-90 transition-opacity" x-transition.opacity>
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-brand-500 mb-4"></div>
            <p class="text-gray-500 animate-pulse">Carregando...</p>
        </div>
    </div>

    <!-- Notifications -->
    <div class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none">
        <template x-for="notif in notifications" :key="notif.id">
            <div class="bg-white border-l-4 p-4 shadow-xl rounded-lg flex items-center justify-between min-w-[320px] pointer-events-auto transform transition-all duration-300 translate-x-0"
                 :class="notif.type === 'error' ? 'border-red-500' : 'border-green-500'"
                 x-transition:enter="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="opacity-0 scale-90">
                <div class="flex items-center">
                    <i :class="notif.type === 'error' ? 'fa-circle-exclamation text-red-500' : 'fa-check-circle text-green-500'" class="fa-solid mr-3 text-xl"></i>
                    <span x-text="notif.message" class="font-medium text-gray-800"></span>
                </div>
            </div>
        </template>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="min-h-screen flex flex-col">

        <!-- Top Navbar -->
        <nav x-show="session || employeeSession" class="bg-black text-white h-16 px-6 flex justify-between items-center shadow-md z-30" x-cloak>
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2">
                    <div class="bg-brand-500 w-8 h-8 rounded flex items-center justify-center text-white font-bold">TA</div>
                    <span class="text-xl font-bold tracking-tight">TechAssist</span>
                </div>

                <div class="hidden md:flex flex-col border-l border-gray-700 pl-6">
                    <span x-show="workspaceName" class="text-gray-200 font-semibold text-sm" x-text="workspaceName"></span>
                    <span x-show="companyCode" class="text-brand-500 text-[10px] font-mono tracking-widest" x-text="'COD: ' + companyCode"></span>
                </div>
            </div>

            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-3">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-medium text-white" x-text="user?.name"></p>
                        <p class="text-xs text-gray-400 capitalize" x-text="employeeSession ? user.roles.join(', ') : 'Administrador'"></p>
                    </div>
                    <div class="bg-gray-800 rounded-full w-10 h-10 flex items-center justify-center text-brand-500 font-bold border border-gray-700">
                        <span x-text="(user?.name || 'U').charAt(0).toUpperCase()"></span>
                    </div>
                </div>
                <button @click="logout()" class="text-gray-400 hover:text-brand-500 transition-colors" title="Sair">
                    <i class="fa-solid fa-power-off text-lg"></i>
                </button>
            </div>
        </nav>

        <div class="flex flex-grow overflow-hidden relative">

            <!-- Sidebar -->
            <aside x-show="session || employeeSession" class="w-20 md:w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col transition-all duration-300" x-cloak>
                <div class="p-4 space-y-2 flex-grow overflow-y-auto">

                    <div class="mb-6 md:px-4">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 hidden md:block">Principal</p>

                        <a href="#" @click.prevent="view = 'dashboard'"
                           :class="view === 'dashboard' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                           class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group mb-1">
                            <i class="fa-solid fa-house w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'dashboard' ? 'text-brand-500' : 'text-gray-400'"></i>
                            <span class="ml-3 font-medium text-sm hidden md:block">Início</span>
                        </a>

                        <a href="#" @click.prevent="view = 'kanban'"
                           :class="view === 'kanban' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                           class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group mb-1">
                            <i class="fa-solid fa-table-columns w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'kanban' ? 'text-brand-500' : 'text-gray-400'"></i>
                            <span class="ml-3 font-medium text-sm hidden md:block">Chamados</span>
                        </a>
                    </div>

                    <!-- Tech Section -->
                    <template x-if="hasRole('admin') || hasRole('tecnico')">
                        <div class="mb-6 md:px-4">
                             <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 hidden md:block">Técnico</p>
                            <a href="#" @click.prevent="view = 'tech_orders'"
                               :class="view === 'tech_orders' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                               class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group">
                                <i class="fa-solid fa-microchip w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'tech_orders' ? 'text-brand-500' : 'text-gray-400'"></i>
                                <span class="ml-3 font-medium text-sm hidden md:block">Minha Bancada</span>
                            </a>
                        </div>
                    </template>

                    <!-- Admin Section -->
                    <template x-if="hasRole('admin')">
                        <div class="mb-6 md:px-4">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 hidden md:block">Gestão</p>
                            <a href="#" @click.prevent="view = 'employees'"
                               :class="view === 'employees' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                               class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group">
                                <i class="fa-solid fa-users-gear w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'employees' ? 'text-brand-500' : 'text-gray-400'"></i>
                                <span class="ml-3 font-medium text-sm hidden md:block">Equipe</span>
                            </a>
                        </div>
                    </template>

                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-grow bg-gray-50 relative overflow-hidden flex flex-col">

                <!-- VIEW: DASHBOARD (Welcome) -->
                <div x-show="view === 'dashboard' && (session || employeeSession)" class="p-8 overflow-y-auto h-full" x-transition.opacity>
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">Visão Geral</h1>
                            <p class="text-gray-500">Resumo das atividades hoje.</p>
                        </div>
                        <button @click="openNewTicketModal()" class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-brand-500 transition-colors shadow-lg flex items-center">
                            <i class="fa-solid fa-plus mr-2"></i> Abrir Chamado
                        </button>
                    </header>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <!-- Stats Cards -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Chamados Abertos</div>
                            <div class="text-4xl font-bold text-gray-900" x-text="tickets.filter(t => t.status !== 'Finalizado').length">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Em Análise</div>
                            <div class="text-4xl font-bold text-brand-500" x-text="tickets.filter(t => t.status === 'Analise Tecnica').length">0</div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Aguardando Aprovação</div>
                            <div class="text-4xl font-bold text-blue-600" x-text="tickets.filter(t => t.status === 'Aprovacao').length">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Prontos p/ Retirada</div>
                            <div class="text-4xl font-bold text-green-600" x-text="tickets.filter(t => t.status === 'Retirada Cliente').length">0</div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: KANBAN BOARD -->
                <div x-show="view === 'kanban'" class="flex-grow flex flex-col h-full overflow-hidden" x-cloak>
                    <!-- Kanban Header -->
                    <div class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-10">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fa-solid fa-layer-group text-brand-500 mr-2"></i> Quadro de Chamados
                        </h2>
                        <div class="flex space-x-2">
                             <button @click="openNewTicketModal()" class="bg-black text-white px-4 py-2 rounded font-medium hover:bg-gray-800 text-sm">
                                <i class="fa-solid fa-plus mr-1"></i> Novo
                            </button>
                        </div>
                    </div>

                    <!-- Kanban Columns Container -->
                    <div class="flex-grow overflow-x-auto overflow-y-hidden p-6">
                        <div class="flex h-full space-x-4 min-w-max">

                            <!-- Loop Columns -->
                            <template x-for="status in STATUS_COLUMNS" :key="status">
                                <div class="w-80 flex flex-col bg-gray-100 rounded-lg h-full border border-gray-200">
                                    <!-- Header -->
                                    <div class="p-3 border-b border-gray-200 bg-gray-200 rounded-t-lg flex justify-between items-center sticky top-0">
                                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide" x-text="status.replace(/_/g, ' ')"></h3>
                                        <span class="bg-white text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm" x-text="tickets.filter(t => t.status === status).length"></span>
                                    </div>

                                    <!-- Cards Area -->
                                    <div class="p-2 flex-grow overflow-y-auto space-y-3 kanban-col">
                                        <template x-for="ticket in tickets.filter(t => t.status === status)" :key="ticket.id">
                                            <div @click="viewTicketDetails(ticket)"
                                                 class="bg-white p-4 rounded-lg shadow-sm border-l-4 cursor-pointer hover:shadow-md transition-shadow group relative"
                                                 :class="getCardColor(ticket) + ' ' + (ticket.priority === 'Urgente' ? 'border-red-500' : 'border-gray-300')">

                                                <!-- Priority Badge -->
                                                <div class="flex justify-between items-start mb-2">
                                                    <span class="text-xs font-bold px-2 py-0.5 rounded uppercase"
                                                          :class="getPriorityColor(ticket.priority)" x-text="ticket.priority"></span>
                                                    <span class="text-xs text-gray-400 font-mono" x-text="'OS: ' + ticket.os_number"></span>
                                                </div>

                                                <h4 class="font-bold text-gray-800 text-sm mb-1 leading-tight" x-text="ticket.device_model"></h4>
                                                <p class="text-xs text-gray-500 truncate mb-2" x-text="ticket.client_name"></p>

                                                <!-- Footer -->
                                                <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-50">
                                                    <div class="text-[10px] text-gray-400 flex items-center">
                                                        <i class="fa-regular fa-clock mr-1"></i>
                                                        <span x-text="new Date(ticket.created_at).toLocaleDateString()"></span>
                                                    </div>
                                                    <div class="h-6 w-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-600">
                                                        <span x-text="(ticket.created_by_name || 'U').charAt(0)"></span>
                                                    </div>
                                                </div>

                                                <!-- Quick Actions Footer -->
                                                <div class="mt-3 pt-3 border-t border-gray-100 grid gap-2" @click.stop>

                                                    <!-- Aberto -->
                                                    <template x-if="ticket.status === 'Aberto'">
                                                        <button @click="updateStatus(ticket, 'Analise Tecnica')" class="w-full bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100">
                                                            Iniciar Análise
                                                        </button>
                                                    </template>

                                                    <!-- Pedir Prioridade (General Action for Tech Stages) -->
                                                    <template x-if="['Analise Tecnica', 'Andamento Reparo'].includes(ticket.status) && !ticket.priority_requested">
                                                        <button @click="requestPriority(ticket)" class="w-full bg-white border border-orange-200 text-orange-600 text-xs font-bold py-2 rounded hover:bg-orange-50 mb-2">
                                                            <i class="fa-solid fa-bell mr-1"></i> Pedir Prioridade
                                                        </button>
                                                    </template>

                                                    <!-- Aprovação -->
                                                    <template x-if="ticket.status === 'Aprovacao'">
                                                        <div>
                                                            <template x-if="ticket.budget_status !== 'Enviado'">
                                                                <button @click="startBudget(ticket)" class="w-full bg-yellow-50 text-yellow-600 text-xs font-bold py-2 rounded hover:bg-yellow-100">
                                                                    Orçamento
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.budget_status === 'Enviado'">
                                                                <div class="flex space-x-2">
                                                                    <button @click="approveRepair(ticket)" class="flex-1 bg-green-50 text-green-600 text-xs font-bold py-2 rounded hover:bg-green-100">Aprovar</button>
                                                                    <button @click="denyRepair(ticket)" class="flex-1 bg-red-50 text-red-600 text-xs font-bold py-2 rounded hover:bg-red-100">Negar</button>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <!-- Compra -->
                                                    <template x-if="ticket.status === 'Compra Peca'">
                                                        <div>
                                                            <template x-if="ticket.parts_status !== 'Comprado'">
                                                                <button @click="markPurchased(ticket)" class="w-full bg-purple-50 text-purple-600 text-xs font-bold py-2 rounded hover:bg-purple-100">
                                                                    Confirmar Compra
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.parts_status === 'Comprado'">
                                                                <button @click="confirmReceived(ticket)" class="w-full bg-teal-50 text-teal-600 text-xs font-bold py-2 rounded hover:bg-teal-100">
                                                                    Recebido
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <!-- Teste Final -->
                                                    <template x-if="ticket.status === 'Teste Final'">
                                                        <div>
                                                            <template x-if="!ticket.test_start_at">
                                                                <button @click="startTest(ticket)" class="w-full bg-indigo-50 text-indigo-600 text-xs font-bold py-2 rounded hover:bg-indigo-100">
                                                                    Iniciar Testes
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.test_start_at">
                                                                <button @click="openOutcomeModal('test', ticket)" class="w-full bg-green-50 text-green-600 text-xs font-bold py-2 rounded hover:bg-green-100">
                                                                    Concluir Testes
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <!-- Retirada -->
                                                    <template x-if="ticket.status === 'Retirada Cliente'">
                                                        <div>
                                                            <template x-if="!ticket.pickup_available">
                                                                <button @click="markAvailable(ticket)" class="w-full bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100">
                                                                    Disponibilizar
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.pickup_available">
                                                                <button @click="confirmPickup(ticket)" class="w-full bg-gray-800 text-white text-xs font-bold py-2 rounded hover:bg-black">
                                                                    Entregar (Finalizar)
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </template>

                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- VIEW: TECH BENCH (Bancada) -->
                <div x-show="view === 'tech_orders'" class="flex-grow p-6 overflow-y-auto flex flex-col" x-cloak>
                    <!-- Header with Title -->
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-wrench mr-2 text-brand-500"></i> Minha Bancada</h2>
                    </div>

                    <!-- Weekly Calendar Bar -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-3">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Agenda Semanal</h3>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" class="sr-only" x-model="showAllCalendarTickets">
                                        <div class="w-10 h-5 bg-gray-200 rounded-full shadow-inner"></div>
                                        <div class="dot absolute w-5 h-5 bg-white rounded-full shadow -left-1 -top-0 transition transform" :class="showAllCalendarTickets ? 'translate-x-full bg-brand-500' : ''"></div>
                                    </div>
                                    <div class="ml-3 text-xs font-bold text-gray-500">Ver Previsão Completa</div>
                                </label>
                            </div>
                            <button @click="modals.calendar = true" class="text-brand-500 hover:text-brand-600 text-xs font-bold uppercase flex items-center">
                                Expandir Mês <i class="fa-solid fa-expand ml-1"></i>
                            </button>
                        </div>

                        <!-- Days Grid -->
                        <div class="grid grid-cols-7 gap-2">
                             <template x-for="day in getWeekDays()" :key="day">
                                 <div class="border rounded-lg p-2 min-h-[80px] relative transition-colors"
                                      :class="isSameDay(day, new Date()) ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-100'">
                                     <div class="text-center mb-1">
                                         <span class="block text-[10px] font-bold uppercase text-gray-400" x-text="day.toLocaleDateString('pt-BR', {weekday: 'short'})"></span>
                                         <span class="block text-sm font-bold text-gray-800" x-text="day.getDate()"></span>
                                     </div>
                                     <!-- Events -->
                                     <div class="space-y-1">
                                         <template x-for="t in getCalendarTickets().filter(x => isSameDay(x.deadline, day))" :key="t.id">
                                             <div class="bg-white border border-gray-200 rounded px-1 py-0.5 text-[9px] shadow-sm truncate cursor-help group relative" :title="t.defect_reported">
                                                 <span class="font-bold" x-text="'OS ' + t.os_number"></span>
                                                 <span class="text-gray-500" x-text="t.device_model"></span>
                                                 <!-- Tooltip -->
                                                 <div class="hidden group-hover:block absolute z-50 bottom-full left-0 w-48 bg-black text-white p-2 rounded text-xs mb-1 shadow-lg">
                                                     <p x-text="t.defect_reported"></p>
                                                 </div>
                                             </div>
                                         </template>
                                     </div>
                                 </div>
                             </template>
                        </div>
                    </div>

                    <!-- Split Columns -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow overflow-hidden">

                        <!-- Col 1: Analise Tecnica -->
                        <div class="flex flex-col h-full overflow-hidden bg-gray-100 rounded-xl border border-gray-200">
                             <div class="p-3 border-b border-gray-200 bg-gray-200 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Em Análise Técnica</h3>
                                <span class="bg-white text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm" x-text="techTickets.filter(t => t.status === 'Analise Tecnica').length"></span>
                            </div>
                            <div class="p-4 overflow-y-auto space-y-4 kanban-col flex-grow">
                                <template x-for="ticket in techTickets.filter(t => t.status === 'Analise Tecnica')" :key="ticket.id">
                                    <!-- Card Component (Reused logic) -->
                                     <div class="bg-white rounded-xl shadow border-t-4 p-4 relative cursor-pointer hover:shadow-md transition-shadow"
                                          @click="viewTicketDetails(ticket, 'tech')"
                                          :class="ticket.priority_requested ? 'border-orange-500 ring-2 ring-orange-400' : (ticket.priority === 'Urgente' ? 'border-red-500' : (ticket.priority === 'Alta' ? 'border-orange-500' : 'border-blue-500'))">

                                        <!-- Priority Requested Badge -->
                                        <div x-show="ticket.priority_requested" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md z-10 whitespace-nowrap">
                                            <i class="fa-solid fa-bell fa-shake mr-1"></i> PRIORIDADE SOLICITADA
                                        </div>

                                        <div class="flex justify-between items-start mb-2 mt-1">
                                            <span class="font-mono text-gray-500 text-xs" x-text="'OS #' + ticket.os_number"></span>
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase" :class="getPriorityColor(ticket.priority)" x-text="ticket.priority"></span>
                                        </div>
                                        <h4 class="font-bold text-gray-900 text-sm mb-1 leading-tight" x-text="ticket.device_model"></h4>
                                        <p class="text-gray-500 text-xs mb-2 line-clamp-2" x-text="ticket.defect_reported"></p>

                                        <div class="text-[10px] text-gray-400 flex items-center mt-2 pt-2 border-t border-gray-50">
                                            <i class="fa-regular fa-clock mr-1"></i>
                                            <span x-text="ticket.deadline ? new Date(ticket.deadline).toLocaleDateString() : 'S/ Prazo'"></span>
                                        </div>
                                     </div>
                                </template>
                                <div x-show="techTickets.filter(t => t.status === 'Analise Tecnica').length === 0" class="text-center py-10 text-gray-400 italic text-sm">
                                    Nenhum item em análise.
                                </div>
                            </div>
                        </div>

                        <!-- Col 2: Andamento Reparo -->
                        <div class="flex flex-col h-full overflow-hidden bg-gray-100 rounded-xl border border-gray-200">
                             <div class="p-3 border-b border-gray-200 bg-gray-200 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Em Andamento Reparo</h3>
                                <span class="bg-white text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm" x-text="techTickets.filter(t => t.status === 'Andamento Reparo').length"></span>
                            </div>
                            <div class="p-4 overflow-y-auto space-y-4 kanban-col flex-grow">
                                <template x-for="ticket in techTickets.filter(t => t.status === 'Andamento Reparo')" :key="ticket.id">
                                     <div class="bg-white rounded-xl shadow border-t-4 p-4 relative cursor-pointer hover:shadow-md transition-shadow"
                                          @click="viewTicketDetails(ticket, 'tech')"
                                          :class="ticket.priority_requested ? 'border-orange-500 ring-2 ring-orange-400' : (ticket.priority === 'Urgente' ? 'border-red-500' : (ticket.priority === 'Alta' ? 'border-orange-500' : 'border-blue-500'))">

                                        <!-- Priority Requested Badge -->
                                        <div x-show="ticket.priority_requested" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md z-10 whitespace-nowrap">
                                            <i class="fa-solid fa-bell fa-shake mr-1"></i> PRIORIDADE SOLICITADA
                                        </div>

                                        <div class="flex justify-between items-start mb-2 mt-1">
                                            <span class="font-mono text-gray-500 text-xs" x-text="'OS #' + ticket.os_number"></span>
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase" :class="getPriorityColor(ticket.priority)" x-text="ticket.priority"></span>
                                        </div>
                                        <h4 class="font-bold text-gray-900 text-sm mb-1 leading-tight" x-text="ticket.device_model"></h4>

                                        <!-- Timer -->
                                        <template x-if="ticket.repair_start_at">
                                            <div class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold mt-2 inline-flex items-center">
                                                <i class="fa-solid fa-stopwatch mr-1"></i>
                                                <span x-text="getDuration(ticket.repair_start_at)"></span>
                                            </div>
                                        </template>

                                        <div class="text-[10px] text-gray-400 flex items-center mt-2 pt-2 border-t border-gray-50">
                                            <i class="fa-regular fa-clock mr-1"></i>
                                            <span x-text="ticket.deadline ? new Date(ticket.deadline).toLocaleDateString() : 'S/ Prazo'"></span>
                                        </div>
                                     </div>
                                </template>
                                <div x-show="techTickets.filter(t => t.status === 'Andamento Reparo').length === 0" class="text-center py-10 text-gray-400 italic text-sm">
                                    Nenhum reparo em andamento.
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- VIEW: EMPLOYEES (Copied from previous file) -->
                <div x-show="(session || employeeSession) && view === 'employees'" class="max-w-7xl mx-auto p-8" x-cloak>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Gerenciar Funcionários</h1>
                        <button @click="openModal('newEmployee')" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 transition-colors">
                            <i class="fa-solid fa-plus mr-2"></i> Novo Funcionário
                        </button>
                    </div>
                    <!-- Table Code (Simplified) -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuário</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Função</th>
                                    <th class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="emp in employees" :key="emp.id">
                                    <tr>
                                        <td class="px-6 py-4" x-text="emp.name"></td>
                                        <td class="px-6 py-4" x-text="emp.username"></td>
                                        <td class="px-6 py-4">
                                             <template x-for="role in emp.roles"><span class="px-2 bg-blue-100 text-blue-800 text-xs rounded-full mr-1" x-text="role"></span></template>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button @click="deleteEmployee(emp.id)" class="text-red-600 hover:text-red-900">Excluir</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: LOGIN/REGISTER (If not logged in) -->
                <div x-show="!session && !employeeSession && !registrationSuccess && view !== 'setup_required'" class="absolute inset-0 bg-white z-50 overflow-y-auto" x-cloak>
                    <div class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                            <div class="text-center mb-8">
                                <div class="bg-black text-white w-12 h-12 rounded-lg flex items-center justify-center text-xl font-bold mx-auto mb-4">TA</div>
                                <h2 class="text-2xl font-bold text-gray-900">Acesso ao Sistema</h2>
                            </div>

                            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                                <button @click="authMode = 'employee'" :class="authMode === 'employee' ? 'bg-white shadow text-black' : 'text-gray-500 hover:text-gray-700'" class="flex-1 py-2 rounded-md text-sm font-bold transition-all">Funcionário</button>
                                <button @click="authMode = 'admin_login'" :class="authMode.includes('admin') ? 'bg-white shadow text-black' : 'text-gray-500 hover:text-gray-700'" class="flex-1 py-2 rounded-md text-sm font-bold transition-all">Admin</button>
                            </div>

                            <!-- Employee Form -->
                            <form x-show="authMode === 'employee'" @submit.prevent="loginEmployee" class="space-y-4">
                                <input type="text" x-model="loginForm.company_code" placeholder="Código da Empresa" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" required>
                                <input type="text" x-model="loginForm.username" placeholder="Usuário" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" required>
                                <input type="password" x-model="loginForm.password" placeholder="Senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" required>
                                <button type="submit" class="w-full bg-brand-500 text-white font-bold py-3 rounded-lg hover:bg-brand-600 transition-colors shadow-lg shadow-orange-500/30">Entrar</button>
                            </form>

                            <!-- Admin Form -->
                            <form x-show="authMode === 'admin_login'" @submit.prevent="loginAdmin" class="space-y-4">
                                <input type="email" x-model="adminForm.email" placeholder="E-mail Admin" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <input type="password" x-model="adminForm.password" placeholder="Senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <button type="submit" class="w-full bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-colors">Entrar Admin</button>
                                <p class="text-center text-sm text-gray-500 mt-4 cursor-pointer hover:text-brand-500" @click="authMode = 'admin_register'">Criar nova empresa</p>
                            </form>

                            <!-- Register Form -->
                             <form x-show="authMode === 'admin_register'" @submit.prevent="registerAdmin" class="space-y-4">
                                <input type="email" x-model="registerForm.email" placeholder="Seu E-mail" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <input type="password" x-model="registerForm.password" placeholder="Crie uma Senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <button type="submit" class="w-full bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-colors">Cadastrar</button>
                                <p class="text-center text-sm text-gray-500 mt-4 cursor-pointer hover:text-brand-500" @click="authMode = 'admin_login'">Voltar ao Login</p>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Setup Required Screen -->
                <div x-show="view === 'setup_required'" class="absolute inset-0 bg-white z-50 flex items-center justify-center" x-cloak>
                    <div class="max-w-md w-full p-8 text-center">
                        <h2 class="text-2xl font-bold mb-4">Bem-vindo!</h2>
                        <p class="mb-6">Para finalizar, qual o nome da sua assistência?</p>
                        <form @submit.prevent="completeCompanySetup">
                            <input type="text" x-model="registerForm.companyName" class="w-full border p-3 rounded mb-4" placeholder="Nome da Empresa" required>
                            <button type="submit" class="bg-black text-white w-full py-3 rounded font-bold">Começar</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODALS -->

    <!-- 1. NEW TICKET MODAL -->
    <div x-show="modals.ticket" class="fixed inset-0 z-[60] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.ticket = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <!-- Header -->
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Novo Chamado</h3>
                    <button @click="modals.ticket = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <!-- Body -->
                <div class="p-6 max-h-[70vh] overflow-y-auto">
                    <!-- Section 1: Basic Info -->
                    <h4 class="text-sm font-bold text-brand-500 uppercase tracking-wide mb-4 border-b pb-2">Informações do Cliente e Aparelho</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Cliente *</label>
                            <input type="text" x-model="ticketForm.client_name" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Contato</label>
                            <input type="text" x-model="ticketForm.contact" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nº OS (Manual) *</label>
                            <input type="text" x-model="ticketForm.os_number" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Prioridade</label>
                            <select x-model="ticketForm.priority" class="w-full border rounded-lg p-2.5 bg-gray-50">
                                <template x-for="p in PRIORITIES"><option :value="p" x-text="p"></option></template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Modelo *</label>
                            <input type="text" x-model="ticketForm.model" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                         <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nº Série / IMEI</label>
                            <input type="text" x-model="ticketForm.serial" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Prazo (Data/Hora)</label>
                            <input type="datetime-local" x-model="ticketForm.deadline" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Situação do Aparelho</label>
                            <input type="text" x-model="ticketForm.device_condition" class="w-full border rounded-lg p-2.5 bg-gray-50" placeholder="Ex: Riscos na tela...">
                        </div>
                         <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Defeito Relatado *</label>
                            <textarea x-model="ticketForm.defect" rows="2" class="w-full border rounded-lg p-2.5 bg-gray-50"></textarea>
                        </div>
                    </div>

                    <!-- Section 2: Checklist -->
                    <div class="mb-6">
                        <div class="flex justify-between items-end border-b pb-2 mb-4">
                            <h4 class="text-sm font-bold text-brand-500 uppercase tracking-wide">Checklist de Entrada</h4>
                            <div class="flex items-center space-x-2">
                                <select x-model="selectedTemplateId" @change="loadTemplate()" class="text-xs border rounded p-1">
                                    <option value="">Carregar Modelo...</option>
                                    <template x-for="t in checklistTemplates" :key="t.id">
                                        <option :value="t.id" x-text="t.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Add Item -->
                        <div class="flex space-x-2 mb-3">
                            <input type="text" x-model="newChecklistItem" @keydown.enter.prevent="addChecklistItem" placeholder="Novo item (ex: Tela trincada?)" class="flex-grow border rounded p-2 text-sm">
                            <button @click="addChecklistItem" class="bg-gray-200 px-3 rounded hover:bg-gray-300"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        <!-- List -->
                        <div class="space-y-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                             <template x-for="(item, idx) in ticketForm.checklist" :key="idx">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" x-model="item.ok" class="text-brand-600 focus:ring-brand-500">
                                        <span class="text-sm font-medium" :class="item.ok ? 'line-through text-gray-400' : 'text-gray-800'" x-text="item.item"></span>
                                    </div>
                                    <button @click="removeChecklistItem(idx)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </template>
                            <div x-show="ticketForm.checklist.length === 0" class="text-center text-gray-400 text-sm italic">Nenhum item no checklist.</div>
                        </div>

                        <!-- Save Template -->
                        <div class="mt-2 flex items-center space-x-2 justify-end">
                            <input type="text" x-model="newTemplateName" placeholder="Nome para salvar modelo" class="text-xs border rounded p-1 w-40">
                            <button @click="saveTemplate()" class="text-xs bg-gray-800 text-white px-2 py-1 rounded">Salvar Modelo</button>
                        </div>
                    </div>

                    <!-- Section 3: Photos (Placeholder) -->
                     <div>
                        <h4 class="text-sm font-bold text-brand-500 uppercase tracking-wide mb-2 border-b pb-2">Fotos</h4>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-400">
                            <i class="fa-solid fa-camera text-2xl mb-2"></i>
                            <p class="text-xs">Upload de fotos em breve.</p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button @click="modals.ticket = false" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg transition-colors">Cancelar</button>
                    <button @click="createTicket()" class="px-6 py-2 bg-brand-500 text-white font-bold rounded-lg hover:bg-brand-600 shadow-lg shadow-orange-500/30 transition-colors">Criar Chamado</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. VIEW/EDIT TICKET MODAL -->
    <div x-show="modals.viewTicket" class="fixed inset-0 z-[70] overflow-y-auto" x-cloak>
         <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.viewTicket = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">

                <template x-if="selectedTicket">
                <div>
                     <!-- Header with Status Actions -->
                    <div class="bg-white border-b px-6 py-4 flex justify-between items-start">
                        <div>
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="bg-black text-white text-xs font-bold px-2 py-1 rounded font-mono" x-text="'OS #' + selectedTicket.os_number"></span>
                                <span class="text-xs font-bold px-2 py-1 rounded uppercase" :class="getPriorityColor(selectedTicket.priority)" x-text="selectedTicket.priority"></span>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900" x-text="selectedTicket.device_model"></h2>
                            <p class="text-gray-500 text-sm" x-text="selectedTicket.client_name"></p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Status Atual</div>
                            <div class="text-lg font-bold text-brand-600" x-text="selectedTicket.status.replace(/_/g, ' ')"></div>

                            <!-- Logs Button (Admin Only) -->
                            <template x-if="hasRole('admin')">
                                <button @click="openLogs(selectedTicket)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300 font-bold transition-colors">
                                    <i class="fa-solid fa-clock-rotate-left mr-1"></i> Ver Histórico
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Action Bar (Logic for Buttons) -->
                    <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">

                        <!-- 1. Aberto -> Analise -->
                        <template x-if="selectedTicket.status === 'Aberto'">
                            <button @click="updateStatus(selectedTicket, 'Analise Tecnica')" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 text-sm shadow flex items-center">
                                <i class="fa-solid fa-microscope mr-2"></i> Iniciar Atendimento (Ir para Análise)
                            </button>
                        </template>

                        <!-- 2. Analise -> Aprovação -->
                        <template x-if="selectedTicket.status === 'Analise Tecnica' && modalSource === 'tech'">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-2">Conclusão da Análise</h4>
                                <div class="mb-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" x-model="analysisForm.needsParts" class="form-checkbox text-blue-600 h-5 w-5">
                                        <span class="text-sm font-bold text-gray-700">Precisa comprar peças?</span>
                                    </label>
                                </div>
                                <div x-show="analysisForm.needsParts" class="mb-3">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Quais peças?</label>
                                    <input type="text" x-model="analysisForm.partsList" class="w-full border rounded p-2 text-sm" placeholder="Ex: Tela, Bateria...">
                                </div>
                                <button @click="finishAnalysis()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 text-sm w-full">
                                    Finalizar e Enviar para Aprovação
                                </button>
                            </div>
                        </template>

                        <!-- 3. Aprovação Flow -->
                        <template x-if="selectedTicket.status === 'Aprovacao'">
                            <div class="flex space-x-3 items-center">
                                <!-- Send Budget Button -->
                                <button @click="sendBudget()"
                                        :disabled="selectedTicket.budget_status === 'Enviado'"
                                        class="px-4 py-2 rounded font-bold text-sm shadow transition-colors"
                                        :class="selectedTicket.budget_status === 'Enviado' ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-yellow-500 text-white hover:bg-yellow-600'">
                                    <i class="fa-solid fa-file-invoice-dollar mr-2"></i>
                                    <span x-text="selectedTicket.budget_status === 'Enviado' ? 'Orçamento Enviado' : 'Enviar Orçamento'"></span>
                                </button>

                                <div class="h-8 w-px bg-gray-300 mx-2"></div>

                                <!-- Approve/Deny (Locked until budget sent) -->
                                <button @click="approveRepair()"
                                        :disabled="selectedTicket.budget_status !== 'Enviado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.budget_status !== 'Enviado' ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'">
                                    <i class="fa-solid fa-check mr-1"></i> Aprovar
                                </button>

                                <button @click="denyRepair()"
                                        :disabled="selectedTicket.budget_status !== 'Enviado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.budget_status !== 'Enviado' ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-red-600 text-white hover:bg-red-700'">
                                    <i class="fa-solid fa-xmark mr-1"></i> Negar
                                </button>
                            </div>
                        </template>

                        <!-- 4. Compra Flow -->
                        <template x-if="selectedTicket.status === 'Compra Peca'">
                            <div class="flex space-x-3 items-center">
                                <button @click="markPurchased()"
                                        :disabled="selectedTicket.parts_status === 'Comprado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.parts_status === 'Comprado' ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-purple-600 text-white hover:bg-purple-700'">
                                    <i class="fa-solid fa-cart-shopping mr-2"></i>
                                    <span x-text="selectedTicket.parts_status === 'Comprado' ? 'Peça Comprada' : 'Confirmar Compra'"></span>
                                </button>

                                <div class="h-8 w-px bg-gray-300 mx-2"></div>

                                <button @click="confirmReceived()"
                                        :disabled="selectedTicket.parts_status !== 'Comprado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.parts_status !== 'Comprado' ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-teal-600 text-white hover:bg-teal-700'">
                                    <i class="fa-solid fa-box-open mr-1"></i> Recebido (Iniciar Reparo)
                                </button>
                            </div>
                        </template>

                        <!-- 5. Reparo Flow -->
                        <template x-if="selectedTicket.status === 'Andamento Reparo' && modalSource === 'tech'">
                            <div class="w-full">
                                <div class="flex space-x-3 mb-2">
                                    <button @click="startRepair()"
                                            x-show="!selectedTicket.repair_start_at"
                                            class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 text-sm shadow flex-grow">
                                        <i class="fa-solid fa-screwdriver-wrench mr-2"></i> Iniciar Execução
                                    </button>

                                    <button @click="openOutcomeModal('repair')"
                                            x-show="selectedTicket.repair_start_at"
                                            class="bg-orange-500 text-white px-4 py-2 rounded font-bold hover:bg-orange-600 text-sm shadow flex-grow">
                                        <i class="fa-solid fa-flag-checkered mr-2"></i> Finalizar Reparo
                                    </button>
                                </div>
                                <div x-show="selectedTicket.repair_start_at" class="text-center bg-gray-100 rounded p-1">
                                    <span class="text-xs text-gray-500 font-bold uppercase">Tempo Decorrido</span>
                                    <div class="text-xl font-mono font-bold text-gray-800" x-text="getDuration(selectedTicket.repair_start_at)"></div>
                                </div>
                            </div>
                        </template>

                        <!-- 6. Teste Final Flow -->
                         <template x-if="selectedTicket.status === 'Teste Final'">
                            <div class="flex space-x-3">
                                 <button @click="startTest()"
                                         x-show="!selectedTicket.test_start_at"
                                         class="bg-indigo-500 text-white px-4 py-2 rounded font-bold hover:bg-indigo-600 text-sm shadow">
                                    <i class="fa-solid fa-vial mr-2"></i> Iniciar Testes
                                </button>

                                <button @click="openOutcomeModal('test')"
                                        x-show="selectedTicket.test_start_at"
                                        class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 text-sm shadow">
                                    <i class="fa-solid fa-clipboard-check mr-2"></i> Concluir Testes
                                </button>
                            </div>
                        </template>

                        <!-- 7. Retirada Flow -->
                        <template x-if="selectedTicket.status === 'Retirada Cliente'">
                             <div class="flex space-x-3 items-center">
                                <button @click="markAvailable()"
                                        :disabled="selectedTicket.pickup_available"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.pickup_available ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'">
                                    <i class="fa-solid fa-bell mr-2"></i>
                                    <span x-text="selectedTicket.pickup_available ? 'Cliente Avisado' : 'Disponível p/ Retirada'"></span>
                                </button>

                                <div class="h-8 w-px bg-gray-300 mx-2"></div>

                                <button @click="confirmPickup()"
                                        :disabled="!selectedTicket.pickup_available"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="!selectedTicket.pickup_available ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gray-800 text-white hover:bg-black'">
                                    <i class="fa-solid fa-handshake mr-1"></i> Retirado (Finalizar)
                                </button>
                            </div>
                        </template>

                        <!-- 8. Finalizado -->
                        <template x-if="selectedTicket.status === 'Finalizado'">
                            <div class="text-center w-full py-2">
                                <span class="px-4 py-2 rounded-full font-bold text-white text-sm"
                                      :class="selectedTicket.repair_successful ? 'bg-green-500' : 'bg-red-500'">
                                      <i class="fa-solid" :class="selectedTicket.repair_successful ? 'fa-check' : 'fa-xmark'"></i>
                                      <span x-text="selectedTicket.repair_successful ? 'Concluído com Sucesso' : 'Concluído sem Sucesso'"></span>
                                </span>
                            </div>
                        </template>

                    </div>

                    <!-- Details Body -->
                    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 max-h-[60vh] overflow-y-auto">

                        <!-- Left: Info -->
                        <div class="col-span-1 space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <h4 class="font-bold text-gray-700 text-xs uppercase mb-2">Dados do Aparelho</h4>
                                <p class="text-sm mb-1"><span class="font-bold">Serial:</span> <span x-text="selectedTicket.serial_number || '-'"></span></p>
                                <p class="text-sm mb-1"><span class="font-bold">Defeito Inicial:</span></p>
                                <p class="text-sm text-gray-600 bg-white p-2 rounded border mb-2" x-text="selectedTicket.defect_reported"></p>

                                <template x-if="selectedTicket.test_notes && selectedTicket.test_notes.length > 0">
                                    <div>
                                        <p class="text-sm mb-1 font-bold text-gray-700">Histórico de Testes:</p>
                                        <div class="space-y-2">
                                            <template x-for="(note, idx) in selectedTicket.test_notes" :key="idx">
                                                <div class="p-2 rounded border bg-white">
                                                    <p class="text-xs text-gray-400 mb-1" x-text="new Date(note.date).toLocaleDateString() + ' - ' + note.user"></p>
                                                    <p :class="idx === selectedTicket.test_notes.length - 1 ? 'text-lg font-bold text-brand-500' : 'text-sm text-gray-600'" x-text="note.text"></p>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                             <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <h4 class="font-bold text-gray-700 text-xs uppercase mb-2">Cliente</h4>
                                <p class="text-sm mb-1"><span class="font-bold">Nome:</span> <span x-text="selectedTicket.client_name"></span></p>
                                <p class="text-sm mb-1"><span class="font-bold">Contato:</span> <span x-text="selectedTicket.contact_info || '-'"></span></p>
                            </div>
                        </div>

                        <!-- Center: Technical & Checklist -->
                        <div class="col-span-2 space-y-4">

                            <!-- Tech Notes -->
                            <div class="border rounded-lg p-4">
                                <h4 class="font-bold text-brand-600 text-sm uppercase mb-2"> <i class="fa-solid fa-pen-to-square mr-1"></i> Análise Técnica</h4>
                                <textarea x-model="selectedTicket.tech_notes" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-brand-500 focus:ring-brand-500" rows="3" placeholder="Relatório técnico..."></textarea>

                                <div class="mt-3">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Peças Necessárias</label>
                                    <input type="text" x-model="selectedTicket.parts_needed" class="w-full text-sm border-gray-300 rounded-md" placeholder="Ex: Tela, Bateria...">
                                </div>
                                <div class="mt-3 text-right">
                                    <button @click="saveTicketChanges()" class="text-xs bg-gray-800 text-white px-3 py-1 rounded hover:bg-black">Salvar Anotações</button>
                                </div>
                            </div>

                            <!-- Checklist Readonly/Edit -->
                            <div class="border rounded-lg p-4 bg-gray-50">
                                <h4 class="font-bold text-gray-600 text-sm uppercase mb-2">Checklist Inicial</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <template x-for="(item, idx) in selectedTicket.checklist_data">
                                        <div class="flex items-center space-x-2 bg-white p-2 rounded border">
                                             <input type="checkbox" x-model="item.ok" class="text-brand-600 focus:ring-brand-500">
                                             <span class="text-sm" x-text="item.item"></span>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="!selectedTicket.checklist_data || selectedTicket.checklist_data.length === 0" class="text-gray-400 text-sm italic">Vazio.</div>
                            </div>

                        </div>
                    </div>
                </div>
                </template>

                <div class="bg-gray-100 px-6 py-3 flex justify-between items-center">
                    <p class="text-xs text-gray-400">ID: <span x-text="selectedTicket?.id"></span></p>
                    <button @click="modals.viewTicket = false" class="text-gray-600 hover:text-black font-bold text-sm">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. LOGS MODAL -->
    <div x-show="modals.logs" class="fixed inset-0 z-[80] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-black bg-opacity-75" @click="modals.logs = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Histórico de Atividades</h3>
                    <div class="flex items-center space-x-4">
                        <button @click="logViewMode = logViewMode === 'timeline' ? 'detailed' : 'timeline'"
                                class="text-xs font-bold uppercase tracking-wider text-brand-500 hover:text-white transition-colors border border-brand-500 px-3 py-1 rounded-full">
                            <i class="fa-solid" :class="logViewMode === 'timeline' ? 'fa-list' : 'fa-timeline'"></i>
                            <span x-text="logViewMode === 'timeline' ? 'Ver Detalhes' : 'Ver Timeline'"></span>
                        </button>
                        <button @click="modals.logs = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                </div>

                <div class="p-0 max-h-[70vh] overflow-y-auto bg-gray-50">
                     <!-- TIMELINE VIEW -->
                     <div x-show="logViewMode === 'timeline'" class="p-6 space-y-4">
                        <template x-for="log in ticketLogs.filter(l => l.user_name !== 'Sistema')" :key="log.id">
                            <div class="flex flex-col relative pl-4 border-l-2 border-gray-200 pb-4 last:border-0 last:pb-0">
                                <!-- Dot -->
                                <div class="absolute -left-[9px] top-0 h-4 w-4 rounded-full bg-brand-500 border-2 border-white"></div>

                                <!-- Content -->
                                <div class="text-sm text-gray-800">
                                    <span class="font-bold capitalize" x-text="log.action"></span>
                                    por <span class="font-bold text-gray-600" x-text="log.user_name"></span>
                                    - <span class="text-gray-500 text-xs" x-text="new Date(log.created_at).toLocaleString()"></span>
                                </div>

                                <!-- Duration Line (If present in details) -->
                                <template x-if="log.details && log.details.includes('Tempo de Reparo')">
                                    <div class="mt-1 text-sm font-bold text-brand-600 flex items-center">
                                        <i class="fa-solid fa-stopwatch mr-2"></i>
                                        <span x-text="'Reparo levou ' + log.details.split('Tempo de Reparo:')[1].trim()"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <div x-show="ticketLogs.filter(l => l.user_name !== 'Sistema').length === 0" class="text-center text-gray-400 italic">
                            Nenhuma atividade de usuário registrada.
                        </div>
                     </div>

                     <!-- DETAILED VIEW -->
                     <div x-show="logViewMode === 'detailed'">
                        <template x-for="log in ticketLogs" :key="log.id">
                            <div class="p-4 border-b border-gray-200 bg-white hover:bg-gray-50 transition-colors">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-bold text-gray-800 text-sm" x-text="log.action"></span>
                                    <span class="text-xs text-gray-500 font-mono" x-text="new Date(log.created_at).toLocaleString()"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <p class="text-sm text-gray-600 flex-grow" x-text="log.details || '-'"></p>
                                    <div class="ml-4 flex items-center">
                                        <div class="h-6 w-6 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-xs font-bold mr-2">
                                            <span x-text="(log.user_name || '?').charAt(0).toUpperCase()"></span>
                                        </div>
                                        <span class="text-xs font-bold text-gray-900" x-text="log.user_name || 'Sistema'"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                     </div>

                    <div x-show="ticketLogs.length === 0" class="p-8 text-center text-gray-500">
                        <i class="fa-solid fa-clock-rotate-left text-3xl mb-2 text-gray-300"></i>
                        <p>Nenhum registro encontrado.</p>
                    </div>
                </div>
                <div class="bg-gray-100 px-6 py-3 flex justify-end">
                     <button @click="modals.logs = false" class="text-sm font-bold text-gray-600 hover:text-black">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. CALENDAR MODAL -->
    <div x-show="modals.calendar" class="fixed inset-0 z-[90] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.calendar = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-5xl sm:w-full">
                <!-- Header -->
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-lg font-bold text-white">Calendário de Prazos</h3>
                        <div class="flex items-center space-x-2 bg-gray-800 rounded-lg p-1">
                            <button @click="changeMonth(-1)" class="text-white hover:text-brand-500 w-8 h-8 rounded flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                            <span class="text-white font-bold w-32 text-center" x-text="currentCalendarDate.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})"></span>
                            <button @click="changeMonth(1)" class="text-white hover:text-brand-500 w-8 h-8 rounded flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <button @click="modals.calendar = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <!-- Body -->
                <div class="p-6 bg-gray-50">
                    <!-- Weekday Headers -->
                    <div class="grid grid-cols-7 gap-px mb-2">
                        <template x-for="day in ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb']">
                             <div class="text-center text-xs font-bold uppercase text-gray-500" x-text="day"></div>
                        </template>
                    </div>

                    <!-- Days -->
                    <div class="grid grid-cols-7 gap-2">
                        <template x-for="(day, idx) in getMonthDays()" :key="idx">
                            <div class="min-h-[120px] bg-white border border-gray-200 rounded-lg p-2 flex flex-col relative"
                                 :class="!day ? 'bg-gray-50 border-transparent' : (isSameDay(day, new Date()) ? 'border-brand-500 ring-1 ring-brand-500' : '')">

                                <template x-if="day">
                                    <div>
                                        <div class="text-right text-xs font-bold mb-2"
                                             :class="isSameDay(day, new Date()) ? 'text-brand-600' : 'text-gray-400'"
                                             x-text="day.getDate()"></div>

                                        <div class="space-y-1 overflow-y-auto max-h-[100px] scrollbar-hide">
                                            <template x-for="t in getCalendarTickets().filter(x => isSameDay(x.deadline, day))" :key="t.id">
                                                 <div class="bg-gray-50 border border-gray-100 rounded px-1.5 py-1 text-[10px] shadow-sm cursor-help hover:bg-black hover:text-white transition-colors group relative truncate" :title="t.defect_reported">
                                                     <span class="font-bold" x-text="'OS ' + t.os_number"></span>
                                                     <span x-text="t.device_model"></span>
                                                     <!-- Tooltip -->
                                                      <div class="hidden group-hover:block absolute z-50 bottom-full left-0 w-48 bg-black text-white p-2 rounded text-xs mb-1 shadow-lg pointer-events-none">
                                                         <p class="font-bold border-b border-gray-700 pb-1 mb-1" x-text="t.client_name"></p>
                                                         <p x-text="t.defect_reported"></p>
                                                     </div>
                                                 </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. OUTCOME MODAL (Success/Fail Logic) -->
    <div x-show="modals.outcome" class="fixed inset-0 z-[80] flex items-center justify-center" x-cloak>
        <div class="fixed inset-0 bg-black bg-opacity-50" @click="modals.outcome = false"></div>
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md z-10 relative">
            <h3 class="text-lg font-bold mb-4" x-text="outcomeMode === 'repair' ? 'Finalizar Reparo' : 'Concluir Testes'"></h3>

            <!-- Repair Outcome -->
            <div x-show="outcomeMode === 'repair'" class="space-y-4">
                <p class="text-gray-600">O reparo foi realizado com sucesso?</p>
                <div class="flex space-x-3">
                    <button @click="finishRepair(true)" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">
                        <i class="fa-solid fa-check mr-2"></i> Sim, Sucesso
                    </button>
                    <button @click="finishRepair(false)" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold hover:bg-red-600">
                        <i class="fa-solid fa-xmark mr-2"></i> Não, Falhou
                    </button>
                </div>
            </div>

            <!-- Test Outcome -->
            <div x-show="outcomeMode === 'test'" class="space-y-4">
                <p class="text-gray-600">O aparelho passou nos testes?</p>
                <div class="flex space-x-3 mb-4">
                    <button @click="concludeTest(true)" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">
                        <i class="fa-solid fa-check mr-2"></i> Aprovado
                    </button>
                    <button @click="showTestFailureForm = true" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold hover:bg-red-600">
                        <i class="fa-solid fa-bug mr-2"></i> Reprovado (Problema)
                    </button>
                </div>

                <div x-show="showTestFailureForm" class="bg-red-50 p-4 rounded border border-red-200" x-transition>
                    <p class="text-xs font-bold text-red-800 mb-2">Retornar para Bancada</p>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500">Novo Prazo</label>
                            <input type="datetime-local" x-model="testFailureData.newDeadline" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500">Nova Prioridade</label>
                            <select x-model="testFailureData.newPriority" class="w-full border rounded p-2 text-sm">
                                <template x-for="p in PRIORITIES"><option :value="p" x-text="p"></option></template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500">Defeito Apresentado</label>
                            <textarea x-model="testFailureData.reason" rows="2" class="w-full border rounded p-2 text-sm" placeholder="Descreva o problema encontrado..."></textarea>
                        </div>
                        <button @click="concludeTest(false)" class="w-full bg-red-800 text-white py-2 rounded font-bold hover:bg-black text-sm">Confirmar Retorno</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS MAIN -->
    <script src="js/main.js?v=3"></script>
</body>
</html>
