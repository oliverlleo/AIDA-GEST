<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CentralOS - Gestão Inteligente</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#FF6B00', // Laranja
                            600: '#E65100',
                            900: '#1a1a1a', // Preto suave
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3/dist/cdn.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar for Kanban */
        .kanban-col::-webkit-scrollbar { width: 4px; }
        .kanban-col::-webkit-scrollbar-thumb { background: #CBD5E0; border-radius: 4px; }
        .kanban-col:hover::-webkit-scrollbar-thumb { background: #A0AEC0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 antialiased" x-data="app()">

    <!-- Loading Overlay -->
    <div x-show="loading" class="fixed inset-0 bg-white z-[99] flex items-center justify-center bg-opacity-90 transition-opacity" x-transition.opacity>
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-brand-500 mb-4"></div>
            <p class="text-gray-500 animate-pulse">Carregando...</p>
        </div>
    </div>

    <!-- Notifications -->
    <div class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none">
        <template x-for="notif in notifications" :key="notif.id">
            <div class="bg-white border-l-4 p-4 shadow-xl rounded-lg flex items-center justify-between min-w-[320px] pointer-events-auto transform transition-all duration-300 translate-x-0"
                 :class="notif.type === 'error' ? 'border-red-500' : 'border-green-500'"
                 x-transition:enter="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="opacity-0 scale-90">
                <div class="flex items-center">
                    <i :class="notif.type === 'error' ? 'fa-circle-exclamation text-red-500' : 'fa-check-circle text-green-500'" class="fa-solid mr-3 text-xl"></i>
                    <span x-text="notif.message" class="font-medium text-gray-800"></span>
                </div>
            </div>
        </template>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="min-h-screen flex flex-col">

        <!-- Top Navbar -->
        <nav x-show="session || employeeSession" class="bg-black text-white h-16 px-6 flex justify-between items-center shadow-md z-30" x-cloak>
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2">
                    <img src="logo.png" alt="CentralOS" class="h-12">
                </div>

                <div class="hidden md:flex flex-col border-l border-gray-700 pl-6">
                    <span x-show="workspaceName" class="text-gray-200 font-semibold text-sm" x-text="workspaceName"></span>
                    <span x-show="companyCode" class="text-brand-500 text-[10px] font-mono tracking-widest" x-text="'COD: ' + companyCode"></span>
                </div>
            </div>

            <div class="flex items-center space-x-6">
                <!-- Notifications Bell -->
                <button @click="modals.notifications = true" class="relative text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-bell text-xl"></i>
                    <span x-show="notificationsList.filter(n => !n.is_read).length > 0"
                          class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse"
                          x-text="notificationsList.filter(n => !n.is_read).length"></span>
                </button>

                <div class="flex items-center space-x-3">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-medium text-white" x-text="user?.name"></p>
                        <p class="text-xs text-gray-400 capitalize" x-text="employeeSession ? user.roles.join(', ') : 'Administrador'"></p>
                    </div>
                    <div class="bg-gray-800 rounded-full w-10 h-10 flex items-center justify-center text-brand-500 font-bold border border-gray-700">
                        <span x-text="(user?.name || 'U').charAt(0).toUpperCase()"></span>
                    </div>
                </div>
                <button @click="logout()" class="text-gray-400 hover:text-brand-500 transition-colors" title="Sair">
                    <i class="fa-solid fa-power-off text-lg"></i>
                </button>
            </div>
        </nav>

        <div class="flex flex-grow overflow-hidden relative">

            <!-- Sidebar -->
            <aside x-show="session || employeeSession" class="w-20 md:w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col transition-all duration-300" x-cloak>
                <div class="p-4 space-y-2 flex-grow overflow-y-auto">

                    <div class="mb-6 md:px-4">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 hidden md:block">Principal</p>

                        <!-- Dashboard (Admin/Atendente only) -->
                        <template x-if="hasRole('admin') || hasRole('atendente')">
                            <a href="#" @click.prevent="view = 'dashboard'"
                               :class="view === 'dashboard' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                               class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group mb-1">
                                <i class="fa-solid fa-house w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'dashboard' ? 'text-brand-500' : 'text-gray-400'"></i>
                                <span class="ml-3 font-medium text-sm hidden md:block">Início</span>
                            </a>
                        </template>

                        <!-- Kanban (Admin/Atendente only) -->
                        <template x-if="hasRole('admin') || hasRole('atendente')">
                            <a href="#" @click.prevent="view = 'kanban'"
                               :class="view === 'kanban' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                               class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group mb-1">
                                <i class="fa-solid fa-table-columns w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'kanban' ? 'text-brand-500' : 'text-gray-400'"></i>
                                <span class="ml-3 font-medium text-sm hidden md:block">Chamados</span>
                            </a>
                        </template>
                    </div>

                    <!-- Tech Section -->
                    <template x-if="hasRole('admin') || hasRole('tecnico')">
                        <div class="mb-6 md:px-4">
                             <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 hidden md:block">Técnico</p>
                            <a href="#" @click.prevent="view = 'tech_orders'"
                               :class="view === 'tech_orders' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                               class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group">
                                <i class="fa-solid fa-microchip w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'tech_orders' ? 'text-brand-500' : 'text-gray-400'"></i>
                                <span class="ml-3 font-medium text-sm hidden md:block">Minha Bancada</span>
                            </a>
                        </div>
                    </template>

                    <!-- Admin Section (Renamed to Configuração) -->
                    <template x-if="hasRole('admin')">
                        <div class="mb-6 md:px-4">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 hidden md:block">Gestão</p>
                            <a href="#" @click.prevent="view = 'admin_dashboard'"
                               :class="view === 'admin_dashboard' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                               class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group mb-1">
                                <i class="fa-solid fa-chart-line w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'admin_dashboard' ? 'text-brand-500' : 'text-gray-400'"></i>
                                <span class="ml-3 font-medium text-sm hidden md:block">Dashboard Gestor</span>
                            </a>
                            <a href="#" @click.prevent="view = 'employees'"
                               :class="view === 'employees' ? 'bg-brand-50 text-brand-600 border-brand-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                               class="flex items-center px-3 py-3 rounded-lg border-l-4 transition-all group">
                                <i class="fa-solid fa-cog w-6 text-center text-lg group-hover:text-brand-500" :class="view === 'employees' ? 'text-brand-500' : 'text-gray-400'"></i>
                                <span class="ml-3 font-medium text-sm hidden md:block">Configuração</span>
                            </a>
                        </div>
                    </template>

                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-grow bg-gray-50 relative overflow-hidden flex flex-col">

                <!-- VIEW: DASHBOARD (Welcome) -->
                <div x-show="view === 'dashboard' && (session || employeeSession)" class="p-8 overflow-y-auto h-full" x-transition.opacity>
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">Visão Geral</h1>
                            <p class="text-gray-500">Resumo das atividades hoje.</p>
                        </div>
                        <button @click="openNewTicketModal()" class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-brand-500 transition-colors shadow-lg flex items-center">
                            <i class="fa-solid fa-plus mr-2"></i> Abrir Chamado
                        </button>
                    </header>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <!-- Stats Cards -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Chamados Abertos</div>
                            <div class="text-4xl font-bold text-gray-900" x-text="tickets.filter(t => t.status !== 'Finalizado').length">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Em Análise</div>
                            <div class="text-4xl font-bold text-brand-500" x-text="tickets.filter(t => t.status === 'Analise Tecnica').length">0</div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Aguardando Aprovação</div>
                            <div class="text-4xl font-bold text-blue-600" x-text="tickets.filter(t => t.status === 'Aprovacao').length">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm font-medium mb-1">Prontos p/ Retirada</div>
                            <div class="text-4xl font-bold text-green-600" x-text="tickets.filter(t => t.status === 'Retirada Cliente').length">0</div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: ADMIN DASHBOARD -->
                <div x-show="view === 'admin_dashboard' && hasRole('admin')" class="p-8 overflow-y-auto h-full" x-transition.opacity x-cloak x-data="{ metrics: {} }" x-init="metrics = getAdminMetrics()" x-effect="metrics = getAdminMetrics()">
                    <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Dashboard do Gestor</h1>
                            <p class="text-gray-500">Painel estratégico para análise detalhada por aparelho, defeito e técnico.</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button class="bg-black text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-brand-500 transition-colors">
                                Exportar relatório
                            </button>
                            <button class="bg-white text-gray-700 px-5 py-2.5 rounded-lg border border-gray-200 font-semibold hover:border-brand-500 hover:text-brand-600 transition-colors">
                                Salvar visão
                            </button>
                        </div>
                    </header>

                    <section class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Filtros inteligentes</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Período</label>
                                <div class="mt-2 flex gap-2">
                                    <input type="date" x-model="adminDashboardFilters.dateStart" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
                                    <input type="date" x-model="adminDashboardFilters.dateEnd" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Modelo de aparelho</label>
                                <select x-model="adminDashboardFilters.deviceModel" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
                                    <option value="all">Todos os modelos</option>
                                    <template x-for="model in deviceModels" :key="model.id">
                                        <option :value="model.name" x-text="model.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Defeito</label>
                                <select x-model="adminDashboardFilters.defect" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
                                    <option value="all">Todos os defeitos</option>
                                    <template x-for="defect in defectOptions" :key="defect.id">
                                        <option :value="defect.name" x-text="defect.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Técnico</label>
                                <select x-model="adminDashboardFilters.technician" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
                                    <option value="all">Todos os técnicos</option>
                                    <template x-for="employee in employees.filter(emp => (emp.roles || []).includes('tecnico'))" :key="employee.id">
                                        <option :value="employee.id" x-text="employee.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Status do reparo</label>
                                <select x-model="adminDashboardFilters.status" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
                                    <option value="all">Todos os status</option>
                                    <template x-for="status in STATUS_COLUMNS" :key="status">
                                        <option :value="status" x-text="getStatusLabel(status)"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Visão rápida</label>
                                <select x-model="adminDashboardFilters.quickView" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
                                    <option value="summary">Resumo executivo</option>
                                    <option value="repair">Detalhar tempo de reparo</option>
                                    <option value="sla">Detalhar SLA e entregas</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button @click="adminDashboardFilters.viewMode = 'standard'; adminDashboardFilters = { ...adminDashboardFilters }" class="w-full bg-brand-500 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-brand-600 transition-colors">
                                    Atualizar visão
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                        <div @click="adminDashboardFilters.viewMode = 'success_drilldown'" class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm cursor-pointer hover:border-brand-500 hover:shadow-md transition-all group relative">
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-brand-500"><i class="fa-solid fa-magnifying-glass-chart"></i></div>
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide group-hover:text-brand-600">Taxa de sucesso (Detalhar)</p>
                            <div class="mt-3 flex items-end justify-between">
                                <span class="text-3xl font-bold text-gray-900 group-hover:text-brand-600" x-text="metrics.successRate !== null ? metrics.successRate + '%' : '-'">-</span>
                                <span class="text-sm text-gray-500 font-semibold" x-text="metrics.filteredTickets?.length ? metrics.filteredTickets.length + ' reparos avaliados' : 'Sem dados'">Sem dados</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">Reparos concluídos com êxito.</p>
                        </div>
                        <div @click="adminDashboardFilters.viewMode = 'repair_drilldown'" class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm cursor-pointer hover:border-brand-500 hover:shadow-md transition-all group relative">
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-brand-500"><i class="fa-solid fa-magnifying-glass-chart"></i></div>
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide group-hover:text-brand-600">Tempo médio de reparo (Detalhar)</p>
                            <div class="mt-3 flex items-end justify-between">
                                <span class="text-3xl font-bold text-gray-900 group-hover:text-brand-600" x-text="formatDuration(metrics.avgRepair)">-</span>
                                <span class="text-sm text-brand-600 font-semibold">Cronômetro técnico</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">Tempo em bancada até finalizar.</p>
                        </div>
                        <div x-show="adminDashboardFilters.quickView !== 'repair'" @click="adminDashboardFilters.viewMode = 'solution_drilldown'" class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm cursor-pointer hover:border-brand-500 hover:shadow-md transition-all group relative">
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-brand-500"><i class="fa-solid fa-magnifying-glass-chart"></i></div>
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide group-hover:text-brand-600">Tempo médio de solução (Detalhar)</p>
                            <div class="mt-3 flex items-end justify-between">
                                <span class="text-3xl font-bold text-gray-900 group-hover:text-brand-600" x-text="formatDuration(metrics.avgSolution)">-</span>
                                <span class="text-sm text-gray-500 font-semibold">Chamado → pronto</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">Até liberar para o cliente.</p>
                        </div>
                        <div x-show="adminDashboardFilters.quickView !== 'repair'" @click="adminDashboardFilters.viewMode = 'delivery_drilldown'" class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm cursor-pointer hover:border-brand-500 hover:shadow-md transition-all group relative">
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-brand-500"><i class="fa-solid fa-magnifying-glass-chart"></i></div>
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide group-hover:text-brand-600">Tempo médio para entrega (Detalhar)</p>
                            <div class="mt-3 flex items-end justify-between">
                                <span class="text-3xl font-bold text-gray-900 group-hover:text-brand-600" x-text="formatDuration(metrics.avgDelivery)">-</span>
                                <span class="text-sm text-gray-500 font-semibold">Chamado → retirada</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">Até o cliente retirar.</p>
                        </div>
                    </section>

                    <!-- DRILLDOWN VIEW: Success Analysis -->
                    <div x-show="adminDashboardFilters.viewMode === 'success_drilldown'" class="space-y-8" x-transition>
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Detalhamento de Taxa de Sucesso e Falhas</h2>

                        <!-- Tech Analysis Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <template x-for="tech in metrics.techDeepDive" :key="tech.name">
                                <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                                    <h4 class="font-bold text-gray-900 mb-3" x-text="tech.name"></h4>
                                    <div class="space-y-3 text-sm">
                                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                                            <p class="text-xs text-red-600 font-bold uppercase mb-1">Maior Dificuldade (Falhas)</p>
                                            <p class="font-medium text-gray-800" x-text="tech.mostFrequentFail"></p>
                                        </div>
                                        <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                                            <p class="text-xs text-green-600 font-bold uppercase mb-1">Maior Sucesso</p>
                                            <p class="font-medium text-gray-800" x-text="tech.mostFrequentSuccess"></p>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Extended Model & Defect Lists -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Models -->
                            <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
                                <h3 class="font-bold text-gray-900 mb-4">Performance por Modelo</h3>
                                <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 scrollbar-hide">
                                    <template x-for="model in metrics.topModels" :key="model.label">
                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors">
                                            <span class="font-bold text-gray-700 text-sm w-1/3 truncate" x-text="model.label" :title="model.label"></span>
                                            <div class="text-right text-xs flex-grow flex justify-end gap-3">
                                                <div class="text-gray-500 font-mono">Total: <span x-text="model.total"></span></div>
                                                <div class="text-green-600 font-bold" x-text="'Suc: ' + (model.successRate || 0) + '% (' + (model.success || 0) + ')'"></div>
                                                <div class="text-red-500" x-text="'Fal: ' + (model.failRate || 0) + '% (' + (model.fail || 0) + ')'"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Defects -->
                            <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
                                <h3 class="font-bold text-gray-900 mb-4">Performance por Defeito</h3>
                                <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 scrollbar-hide">
                                    <template x-for="defect in metrics.topDefects" :key="defect.label">
                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors">
                                            <span class="font-bold text-gray-700 text-sm w-1/3 truncate" x-text="defect.label" :title="defect.label"></span>
                                            <div class="text-right text-xs flex-grow flex justify-end gap-3">
                                                <div class="text-gray-500 font-mono">Total: <span x-text="defect.total"></span></div>
                                                <div class="text-green-600 font-bold" x-text="'Suc: ' + (defect.successRate || 0) + '% (' + (defect.success || 0) + ')'"></div>
                                                <div class="text-red-500" x-text="'Fal: ' + (defect.failRate || 0) + '% (' + (defect.fail || 0) + ')'"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DRILLDOWN VIEW: Solution Time Analysis -->
                    <div x-show="adminDashboardFilters.viewMode === 'solution_drilldown'" class="space-y-8" x-transition>
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Análise de Tempo de Solução (Criado → Pronto)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Slowest Models -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Modelos Mais Demorados</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestModelsSolution" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestModelsSolution?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Slowest Defects -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Defeitos Mais Demorados</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestDefectsSolution" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestDefectsSolution?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Slowest Combos -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Casos Complexos</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestCombosSolution" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestCombosSolution?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Fastest Techs -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-green-600 text-sm uppercase mb-3">Eficiência Técnica</h4>
                                <div class="space-y-2">
                                    <template x-for="(tech, idx) in metrics.fastestTechsSolution" :key="tech.name">
                                        <div class="p-2 bg-gray-50 rounded border-l-4" :class="idx === 0 ? 'border-green-500' : 'border-gray-300'">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="font-bold text-gray-800 text-xs" x-text="tech.name"></span>
                                                <span class="text-[10px] bg-black text-white px-1.5 rounded" x-text="tech.successRate + '% Sucesso'"></span>
                                            </div>
                                            <div class="text-right font-mono text-sm text-gray-600" x-text="formatDuration(tech.avgTime)"></div>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.fastestTechsSolution?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DRILLDOWN VIEW: Delivery Time Analysis -->
                    <div x-show="adminDashboardFilters.viewMode === 'delivery_drilldown'" class="space-y-8" x-transition>
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Análise de Tempo de Entrega (Criado → Entregue)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Slowest Models -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Modelos - Retirada Lenta</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestModelsDelivery" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestModelsDelivery?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Slowest Defects -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Defeitos - Retirada Lenta</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestDefectsDelivery" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestDefectsDelivery?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Slowest Combos -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Casos Complexos</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestCombosDelivery" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestCombosDelivery?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Fastest Techs -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-green-600 text-sm uppercase mb-3">Agilidade Geral</h4>
                                <div class="space-y-2">
                                    <template x-for="(tech, idx) in metrics.fastestTechsDelivery" :key="tech.name">
                                        <div class="p-2 bg-gray-50 rounded border-l-4" :class="idx === 0 ? 'border-green-500' : 'border-gray-300'">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="font-bold text-gray-800 text-xs" x-text="tech.name"></span>
                                                <span class="text-[10px] bg-black text-white px-1.5 rounded" x-text="tech.successRate + '% Sucesso'"></span>
                                            </div>
                                            <div class="text-right font-mono text-sm text-gray-600" x-text="formatDuration(tech.avgTime)"></div>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.fastestTechsDelivery?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DRILLDOWN VIEW: Repair Time Analysis -->
                    <div x-show="adminDashboardFilters.viewMode === 'repair_drilldown'" class="space-y-8" x-transition>
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Análise de Tempos de Reparo (Os Mais Demorados)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Slowest Models -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Top 5 Modelos Lentos</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestModels" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestModels?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Slowest Defects -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Top 5 Defeitos Lentos</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestDefects" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestDefects?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Slowest Combos -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-red-600 text-sm uppercase mb-3">Casos Complexos</h4>
                                <div class="space-y-2">
                                    <template x-for="item in metrics.slowestCombos" :key="item.label">
                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                            <span class="font-bold text-gray-700 truncate w-1/2" x-text="item.label"></span>
                                            <span class="font-mono text-gray-900" x-text="formatDuration(item.avgTime)"></span>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.slowestCombos?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>

                            <!-- Fastest Techs -->
                            <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <h4 class="font-bold text-green-600 text-sm uppercase mb-3">Ranking de Velocidade</h4>
                                <div class="space-y-2">
                                    <template x-for="(tech, idx) in metrics.fastestTechs" :key="tech.name">
                                        <div class="p-2 bg-gray-50 rounded border-l-4" :class="idx === 0 ? 'border-green-500' : 'border-gray-300'">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="font-bold text-gray-800 text-xs" x-text="tech.name"></span>
                                                <span class="text-[10px] bg-black text-white px-1.5 rounded" x-text="tech.successRate + '% Sucesso'"></span>
                                            </div>
                                            <div class="text-right font-mono text-sm text-gray-600" x-text="formatDuration(tech.avgTime)"></div>
                                        </div>
                                    </template>
                                    <div x-show="!metrics.fastestTechs?.length" class="text-xs text-gray-400 italic">Sem dados.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STANDARD VIEW SECTIONS -->
                    <section x-show="adminDashboardFilters.viewMode === 'standard'" class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
                            <h3 class="text-sm font-semibold text-gray-900 mb-4">Volume Atual (Bancada)</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Em análise (Agora)</span>
                                    <span class="text-lg font-bold text-gray-900" x-text="metrics.analysisCount + ' aparelhos'">0 aparelhos</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Em reparo (Agora)</span>
                                    <span class="text-lg font-bold text-gray-900" x-text="metrics.repairCount + ' aparelhos'">0 aparelhos</span>
                                </div>
                                <div class="bg-gray-100 rounded-lg px-4 py-3 text-sm text-gray-500">
                                    Instantâneo da bancada.
                                </div>
                            </div>
                        </div>
                        <div x-show="adminDashboardFilters.quickView !== 'repair'" class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
                            <h3 class="text-sm font-semibold text-gray-900 mb-4">Chamados e orçamentos</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Chamados por dia</span>
                                    <span class="text-lg font-semibold text-gray-900" x-text="metrics.ticketsPerDay">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Tempo para orçamento</span>
                                    <span class="text-lg font-semibold text-gray-900" x-text="formatDuration(metrics.avgBudget)">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Aviso de retirada</span>
                                    <span class="text-lg font-semibold text-gray-900" x-text="formatDuration(metrics.avgPickupNotify)">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
                            <h3 class="text-sm font-semibold text-gray-900 mb-4">Técnicos e performance</h3>
                            <div class="space-y-4">
                                <template x-if="metrics.techStats?.length">
                                    <div class="space-y-3">
                                        <template x-for="tech in metrics.techStats.slice(0, 3)" :key="tech.id">
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-500" x-text="tech.name"></span>
                                                <span class="text-lg font-semibold text-gray-900" x-text="tech.total + ' aparelhos · ' + (tech.successRate !== null ? tech.successRate + '%' : '-')"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="!metrics.techStats?.length">
                                    <div class="text-sm text-gray-500">Sem dados de técnicos no período.</div>
                                </template>
                            </div>
                        </div>
                    </section>

                    <section x-show="adminDashboardFilters.viewMode === 'standard'" class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-semibold text-gray-900">Reparos por dia/semana/mês</h3>
                                <span class="text-xs text-gray-500 uppercase tracking-wide">Volume</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="rounded-xl border border-gray-200 p-4 text-center">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Hoje</p>
                                    <p class="text-2xl font-semibold text-gray-900" x-text="metrics.repairsToday">0</p>
                                </div>
                                <div class="rounded-xl border border-gray-200 p-4 text-center">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Semana</p>
                                    <p class="text-2xl font-semibold text-gray-900" x-text="metrics.repairsWeek">0</p>
                                </div>
                                <div class="rounded-xl border border-gray-200 p-4 text-center">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Mês</p>
                                    <p class="text-2xl font-semibold text-gray-900" x-text="metrics.repairsMonth">0</p>
                                </div>
                            </div>

                            <div class="flex items-center justify-between mt-6 mb-4">
                                <h3 class="text-sm font-semibold text-gray-900">Chamados Criados</h3>
                                <span class="text-xs text-gray-500 uppercase tracking-wide">Entrada</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="rounded-xl border border-gray-200 p-4 text-center">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Hoje</p>
                                    <p class="text-2xl font-semibold text-gray-900" x-text="metrics.ticketsToday || 0">0</p>
                                </div>
                                <div class="rounded-xl border border-gray-200 p-4 text-center">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Semana</p>
                                    <p class="text-2xl font-semibold text-gray-900" x-text="metrics.ticketsWeek || 0">0</p>
                                </div>
                                <div class="rounded-xl border border-gray-200 p-4 text-center">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Mês</p>
                                    <p class="text-2xl font-semibold text-gray-900" x-text="metrics.ticketsMonth || 0">0</p>
                                </div>
                            </div>

                            <div class="mt-4 flex flex-wrap gap-3 text-xs text-gray-500">
                                <template x-for="model in metrics.topModels" :key="model.label">
                                    <span class="bg-gray-100 px-3 py-1 rounded-full" x-text="'Modelo: ' + model.label + ' (' + (model.total || 0) + ')'"></span>
                                </template>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm flex flex-col h-full max-h-[600px]">
                            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                                <h3 class="text-sm font-semibold text-gray-900">Defeitos mais frequentes</h3>
                                <div class="flex gap-4 text-xs font-bold text-gray-400 uppercase tracking-wide cursor-pointer select-none">
                                    <span @click="adminDashboardFilters.defectSortField='total'; adminDashboardFilters.defectSortDesc = !adminDashboardFilters.defectSortDesc"
                                          :class="adminDashboardFilters.defectSortField === 'total' ? 'text-black underline' : 'hover:text-gray-600'">
                                        Total <i x-show="adminDashboardFilters.defectSortField === 'total'" class="fa-solid" :class="adminDashboardFilters.defectSortDesc ? 'fa-sort-down' : 'fa-sort-up'"></i>
                                    </span>
                                    <span @click="adminDashboardFilters.defectSortField='success'; adminDashboardFilters.defectSortDesc = !adminDashboardFilters.defectSortDesc"
                                          class="text-green-600" :class="adminDashboardFilters.defectSortField === 'success' ? 'underline' : 'hover:text-green-800'">
                                        Sucesso <i x-show="adminDashboardFilters.defectSortField === 'success'" class="fa-solid" :class="adminDashboardFilters.defectSortDesc ? 'fa-sort-down' : 'fa-sort-up'"></i>
                                    </span>
                                    <span @click="adminDashboardFilters.defectSortField='fail'; adminDashboardFilters.defectSortDesc = !adminDashboardFilters.defectSortDesc"
                                          class="text-red-500" :class="adminDashboardFilters.defectSortField === 'fail' ? 'underline' : 'hover:text-red-700'">
                                        Falha <i x-show="adminDashboardFilters.defectSortField === 'fail'" class="fa-solid" :class="adminDashboardFilters.defectSortDesc ? 'fa-sort-down' : 'fa-sort-up'"></i>
                                    </span>
                                </div>
                            </div>

                            <div class="space-y-3 overflow-y-auto pr-2 scrollbar-hide flex-grow" style="max-height: 250px;">
                                <template x-for="defect in metrics.topDefects" :key="defect.label">
                                    <div class="flex items-center justify-between py-2 border-b border-gray-50 last:border-0 hover:bg-gray-50 rounded px-2 transition-colors">
                                        <span class="text-gray-700 text-sm font-medium truncate w-5/12" x-text="defect.label" :title="defect.label"></span>
                                        <div class="flex flex-1 justify-end items-center gap-2 text-sm font-mono">
                                            <div class="w-10 text-center font-bold text-gray-900" x-text="defect.total || 0"></div>
                                            <div class="w-20 text-right text-green-600 text-xs">
                                                <span x-text="defect.success || 0"></span>
                                                <span class="opacity-75" x-text="'(' + (defect.successRate || 0) + '%)'"></span>
                                            </div>
                                            <div class="w-20 text-right text-red-500 text-xs">
                                                <span x-text="defect.fail || 0"></span>
                                                <span class="opacity-75" x-text="'(' + (defect.failRate || 0) + '%)'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="!metrics.topDefects?.length">
                                    <div class="text-sm text-gray-500 italic text-center py-4">Sem dados de defeitos.</div>
                                </template>
                            </div>

                            <div class="mt-4 pt-4 border-t border-dashed border-gray-200 flex-grow flex flex-col overflow-hidden">
                                <div class="flex items-center justify-between mb-2 flex-shrink-0">
                                    <span class="text-xs text-gray-500 uppercase tracking-wide font-bold">Aparelho x Defeito</span>
                                </div>
                                <div class="space-y-2 overflow-y-auto pr-2 scrollbar-hide flex-grow" style="max-height: 200px;">
                                    <template x-for="combo in metrics.topCombos" :key="combo.label">
                                        <div class="flex items-center justify-between text-xs py-1.5 hover:bg-gray-50 rounded px-2 transition-colors">
                                            <span class="text-gray-600 truncate w-5/12" x-text="combo.label" :title="combo.label"></span>
                                            <div class="flex flex-1 justify-end items-center gap-2 font-mono">
                                                <div class="w-10 text-center font-bold text-gray-900" x-text="combo.total || 0"></div>
                                                <div class="w-20 text-right text-green-600">
                                                    <span x-text="combo.success || 0"></span>
                                                    <span class="opacity-75" x-text="'(' + (combo.successRate || 0) + '%)'"></span>
                                                </div>
                                                <div class="w-20 text-right text-red-500">
                                                    <span x-text="combo.fail || 0"></span>
                                                    <span class="opacity-75" x-text="'(' + (combo.failRate || 0) + '%)'"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="!metrics.topCombos?.length">
                                        <div class="text-sm text-gray-500 italic text-center py-4">Sem combinações registradas.</div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- VIEW: KANBAN BOARD -->
                <div x-show="view === 'kanban'" class="flex-grow flex flex-col h-full overflow-hidden" x-cloak>
                    <!-- Kanban Header -->
                    <div class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-10">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fa-solid fa-layer-group text-brand-500 mr-2"></i> Quadro de Chamados
                        </h2>
                        <div class="flex space-x-3 items-center">
                             <!-- Search Bar -->
                             <div class="relative">
                                 <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                 <input type="text" x-model="searchQuery" placeholder="Buscar OS, Cliente, Serial..."
                                        class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all w-64 bg-gray-50 focus:bg-white">
                             </div>

                             <div class="flex items-center space-x-2">
                                <button @click="showFinalized = !showFinalized"
                                        class="text-xs px-3 py-2 rounded font-bold border border-gray-300 text-gray-600 hover:bg-gray-100 transition-colors"
                                        :class="showFinalized ? 'bg-gray-100 text-brand-600 border-brand-200' : ''">
                                    <i class="fa-solid" :class="showFinalized ? 'fa-eye' : 'fa-eye-slash'"></i>
                                    <span x-text="showFinalized ? 'Ocultar Finalizados' : 'Mostrar Finalizados'" class="ml-1 hidden sm:inline"></span>
                                </button>
                                <button @click="openNewTicketModal()" class="bg-black text-white px-4 py-2 rounded font-medium hover:bg-gray-800 text-sm">
                                    <i class="fa-solid fa-plus mr-1"></i> Novo
                                </button>
                             </div>
                        </div>
                    </div>

                    <!-- Kanban Columns Container -->
                    <div class="flex-grow overflow-x-auto overflow-y-hidden p-6">
                        <div class="flex h-full space-x-4 min-w-max">

                            <!-- Loop Columns -->
                            <template x-for="status in STATUS_COLUMNS" :key="status">
                                <div x-show="showFinalized || status !== 'Finalizado'" class="w-80 flex flex-col bg-gray-100 rounded-lg h-full border border-gray-200">
                                    <!-- Header -->
                                    <div class="p-3 border-b border-gray-200 bg-gray-200 rounded-t-lg flex justify-between items-center sticky top-0">
                                         <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide" x-text="getStatusLabel(status)"></h3>
                                        <span class="bg-white text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm" x-text="tickets.filter(t => t.status === status).length"></span>
                                    </div>

                                    <!-- Cards Area -->
                                    <div class="p-2 flex-grow overflow-y-auto space-y-3 kanban-col">
                                         <template x-for="ticket in tickets.filter(t => t.status === status && matchesSearch(t))" :key="ticket.id">
                                            <div @click="viewTicketDetails(ticket)"
                                                 class="bg-white p-4 rounded-lg shadow-sm border-l-4 cursor-pointer hover:shadow-md transition-shadow group relative"
                                                 :class="getCardColor(ticket) + ' ' + (ticket.priority === 'Urgente' ? 'border-red-500' : 'border-gray-300')">

                                                <!-- Priority Badge -->
                                                <div class="flex justify-between items-start mb-2">
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs font-bold px-2 py-0.5 rounded uppercase"
                                                              :class="getPriorityColor(ticket.priority)" x-text="ticket.priority"></span>
                                                        <!-- Success/Fail Badge for Finished Tickets -->
                                                        <template x-if="ticket.repair_successful !== null && (ticket.status === 'Finalizado' || ticket.status === 'Retirada Cliente')">
                                                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase"
                                                                  :class="ticket.repair_successful ? 'bg-green-100 text-green-700 border-green-300' : 'bg-red-100 text-red-700 border-red-300'">
                                                                <i class="fa-solid" :class="ticket.repair_successful ? 'fa-check' : 'fa-xmark'"></i>
                                                                <span x-text="ticket.repair_successful ? 'Sucesso' : 'Sem Sucesso'"></span>
                                                            </span>
                                                        </template>
                                                    </div>
                                                    <span class="text-xs text-gray-400 font-mono" x-text="'OS: ' + ticket.os_number"></span>
                                                </div>

                                                <h4 class="font-bold text-gray-800 text-sm mb-1 leading-tight" x-text="ticket.device_model"></h4>
                                                <p class="text-xs text-gray-500 truncate mb-2" x-text="ticket.client_name"></p>

                                                <!-- Footer -->
                                                <div class="mt-3 pt-2 border-t border-gray-50 space-y-1">
                                                    <!-- Deadlines Section -->
                                                    <div class="space-y-0.5 mb-2">
                                                <!-- Analysis Deadline -->
                                                <template x-if="ticket.analysis_deadline">
                                                    <div class="flex items-center justify-between text-[10px]">
                                                        <span class="font-bold text-gray-500 uppercase">Análise:</span>
                                                        <div class="flex items-center font-medium"
                                                             :class="new Date(ticket.analysis_deadline) < new Date() ? 'text-red-600 font-bold' : 'text-gray-500'">
                                                            <i class="fa-solid fa-stopwatch mr-1 text-[9px]"></i>
                                                            <span x-text="new Date(ticket.analysis_deadline).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' })"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Delivery Deadline -->
                                                <div class="flex items-center justify-between text-[10px]">
                                                    <span class="font-bold text-gray-500 uppercase">Entrega:</span>
                                                    <div class="flex items-center font-medium" :class="ticket.deadline && new Date(ticket.deadline) < new Date() ? 'text-red-600 font-bold' : 'text-gray-500'">
                                                        <i class="fa-regular fa-calendar-check mr-1 text-[9px]"></i>
                                                        <span x-text="ticket.deadline ? new Date(ticket.deadline).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' }) : 'S/ Prazo'"></span>
                                                    </div>
                                                </div>
                                                    </div>

                                                    <div class="flex justify-between items-center text-[10px] text-gray-400 border-t border-gray-50 pt-1">
                                                        <div class="flex items-center" title="Criado em">
                                                            <i class="fa-regular fa-clock mr-1"></i>
                                                            <span x-text="new Date(ticket.created_at).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })"></span>
                                                        </div>
                                                        <div class="h-5 w-5 rounded-full bg-gray-100 flex items-center justify-center text-[9px] font-bold text-gray-600" title="Criado por">
                                                            <span x-text="(ticket.created_by_name || 'U').charAt(0)"></span>
                                                        </div>
                                                    </div>
                                                    <div class="text-[10px] font-bold text-gray-600 truncate">
                                                        Técnico: <span class="font-normal" x-text="getEmployeeName(ticket.technician_id)"></span>
                                                    </div>
                                                </div>

                                                <!-- Quick Actions Footer -->
                                                <div class="mt-3 pt-3 border-t border-gray-100 grid gap-2" @click.stop>

                                                    <!-- Aberto -->
                                                    <template x-if="ticket.status === 'Aberto'">
                                                        <button @click="updateStatus(ticket, 'Analise Tecnica', {}, { action: 'Iniciou Atendimento', details: 'Moveu para Análise Técnica via Kanban' })" class="w-full bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100">
                                                            Iniciar Análise
                                                        </button>
                                                    </template>

                                                    <!-- Pedir Prioridade (General Action for Tech Stages) -->
                                                    <template x-if="['Analise Tecnica', 'Andamento Reparo'].includes(ticket.status) && !ticket.priority_requested">
                                                        <button @click="requestPriority(ticket)" class="w-full bg-white border border-orange-200 text-orange-600 text-xs font-bold py-2 rounded hover:bg-orange-50 mb-2">
                                                            <i class="fa-solid fa-bell mr-1"></i> Pedir Prioridade
                                                        </button>
                                                    </template>

                                                    <!-- Aprovação -->
                                                    <template x-if="ticket.status === 'Aprovacao'">
                                                        <div>
                                                            <template x-if="ticket.budget_status !== 'Enviado'">
                                                                <button @click="startBudget(ticket)" class="w-full bg-yellow-50 text-yellow-600 text-xs font-bold py-2 rounded hover:bg-yellow-100">
                                                                    Orçamento
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.budget_status === 'Enviado'">
                                                                <div class="flex space-x-2">
                                                                    <button @click="approveRepair(ticket)" class="flex-1 bg-green-50 text-green-600 text-xs font-bold py-2 rounded hover:bg-green-100">Aprovar</button>
                                                                    <button @click="denyRepair(ticket)" class="flex-1 bg-red-50 text-red-600 text-xs font-bold py-2 rounded hover:bg-red-100">Negar</button>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <!-- Compra -->
                                                    <template x-if="ticket.status === 'Compra Peca'">
                                                        <div>
                                                            <template x-if="ticket.parts_status !== 'Comprado'">
                                                                <button @click="markPurchased(ticket)" class="w-full bg-purple-50 text-purple-600 text-xs font-bold py-2 rounded hover:bg-purple-100">
                                                                    Confirmar Compra
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.parts_status === 'Comprado'">
                                                                <button @click="confirmReceived(ticket)" class="w-full bg-teal-50 text-teal-600 text-xs font-bold py-2 rounded hover:bg-teal-100">
                                                                    Recebido
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <!-- Teste Final -->
                                                    <template x-if="ticket.status === 'Teste Final'">
                                                        <div>
                                                            <template x-if="!ticket.test_start_at">
                                                                <button @click="startTest(ticket)" class="w-full bg-indigo-50 text-indigo-600 text-xs font-bold py-2 rounded hover:bg-indigo-100">
                                                                    Iniciar Testes
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.test_start_at">
                                                                <button @click="openOutcomeModal('test', ticket)" class="w-full bg-green-50 text-green-600 text-xs font-bold py-2 rounded hover:bg-green-100">
                                                                    Concluir Testes
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <!-- Retirada -->
                                                    <template x-if="ticket.status === 'Retirada Cliente'">
                                                        <div>
                                                            <template x-if="!ticket.pickup_available">
                                                                <button @click="markAvailable(ticket)" class="w-full bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100">
                                                                    Disponibilizar
                                                                </button>
                                                            </template>
                                                            <template x-if="ticket.pickup_available">
                                                                <button @click="confirmPickup(ticket)" class="w-full bg-gray-800 text-white text-xs font-bold py-2 rounded hover:bg-black">
                                                                    Entregar (Finalizar)
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </template>

                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- VIEW: TECH BENCH (Bancada) -->
                <div x-show="view === 'tech_orders'" class="flex-grow p-6 overflow-y-auto flex flex-col" x-cloak>
                    <!-- Header with Title & Filter -->
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-wrench mr-2 text-brand-500"></i> Minha Bancada</h2>

                         <div class="flex items-center space-x-3">
                             <!-- Search Bar (Tech) -->
                             <div class="relative">
                                 <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                 <input type="text" x-model="searchQuery" placeholder="Buscar na Bancada..."
                                        class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all w-64 bg-white">
                             </div>

                             <!-- Tech Filter (Admin: Dropdown, Tech: Fixed) -->
                             <div x-show="hasRole('admin') || hasRole('tecnico')">
                                 <div class="flex items-center space-x-2 bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                                     <i class="fa-solid fa-filter text-gray-400 text-xs"></i>
                                 <template x-if="hasRole('admin')">
                                     <select x-model="selectedTechFilter" @change="fetchTickets()" class="text-sm font-bold text-gray-700 bg-transparent border-none focus:ring-0 cursor-pointer">
                                         <option value="all">Todos os Técnicos</option>
                                         <template x-for="tech in getTechnicians()" :key="tech.id">
                                             <option :value="tech.id" x-text="tech.name"></option>
                                         </template>
                                     </select>
                                 </template>
                                 <template x-if="!hasRole('admin') && hasRole('tecnico') && user">
                                     <span class="text-sm font-bold text-gray-700" x-text="user.name"></span>
                                 </template>
                             </div>
                         </div>
                    </div>
                </div>

                    <!-- Weekly Calendar Bar -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-3">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Agenda Semanal</h3>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" class="sr-only" x-model="showAllCalendarTickets">
                                        <div class="w-10 h-5 bg-gray-200 rounded-full shadow-inner"></div>
                                        <div class="dot absolute w-5 h-5 bg-white rounded-full shadow -left-1 -top-0 transition transform" :class="showAllCalendarTickets ? 'translate-x-full bg-brand-500' : ''"></div>
                                    </div>
                                    <div class="ml-3 text-xs font-bold text-gray-500">Ver Previsão Completa</div>
                                </label>
                            </div>
                            <button @click="modals.calendar = true" class="text-brand-500 hover:text-brand-600 text-xs font-bold uppercase flex items-center">
                                Expandir Mês <i class="fa-solid fa-expand ml-1"></i>
                            </button>
                        </div>

                        <!-- Days Grid -->
                        <div class="grid grid-cols-7 gap-2">
                             <template x-for="day in getWeekDays()" :key="day">
                                 <div class="border rounded-lg p-2 min-h-[80px] relative transition-colors"
                                      :class="isSameDay(day, new Date()) ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-100'">
                                     <div class="text-center mb-1">
                                         <span class="block text-[10px] font-bold uppercase text-gray-400" x-text="day.toLocaleDateString('pt-BR', {weekday: 'short'})"></span>
                                         <span class="block text-sm font-bold text-gray-800" x-text="day.getDate()"></span>
                                     </div>
                                     <!-- Events -->
                                     <div class="space-y-1">
                                         <template x-for="t in getCalendarTickets().filter(x => isSameDay(x.deadline, day))" :key="t.id">
                                             <div class="bg-white border border-gray-200 rounded px-1 py-0.5 text-[9px] shadow-sm truncate cursor-help group relative" :title="t.defect_reported">
                                                 <span class="font-bold" x-text="'OS ' + t.os_number"></span>
                                                 <span class="text-gray-500" x-text="t.device_model"></span>
                                                 <!-- Tooltip -->
                                                 <div class="hidden group-hover:block absolute z-50 bottom-full left-0 w-48 bg-black text-white p-2 rounded text-xs mb-1 shadow-lg">
                                                     <p x-text="t.defect_reported"></p>
                                                 </div>
                                             </div>
                                         </template>
                                     </div>
                                 </div>
                             </template>
                        </div>
                    </div>

                    <!-- Split Columns -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow overflow-hidden">

                        <!-- Col 1: Analise Tecnica -->
                        <div class="flex flex-col h-full overflow-hidden bg-gray-100 rounded-xl border border-gray-200">
                             <div class="p-3 border-b border-gray-200 bg-gray-200 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Em Análise Técnica</h3>
                                <span class="bg-white text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm" x-text="techTickets.filter(t => t.status === 'Analise Tecnica').length"></span>
                            </div>
                            <div class="p-4 overflow-y-auto space-y-4 kanban-col flex-grow">
                                <template x-for="ticket in techTickets.filter(t => t.status === 'Analise Tecnica' && matchesSearch(t))" :key="ticket.id">
                                    <!-- Card Component (Reused logic) -->
                                     <div class="bg-white rounded-xl shadow border-t-4 p-4 relative cursor-pointer hover:shadow-md transition-shadow duration-500"
                                          @click="viewTicketDetails(ticket, 'tech')"
                                          :class="[
                                              ticket.priority_requested ? 'border-orange-500 ring-2 ring-orange-400' : (ticket.priority === 'Urgente' ? 'border-red-500' : (ticket.priority === 'Alta' ? 'border-orange-500' : 'border-blue-500')),
                                              (ticket.deadline && (new Date(ticket.deadline) - new Date()) > 0 && (new Date(ticket.deadline) - new Date()) < 3600000) ? 'animate-pulse ring-2 ring-red-400 ring-opacity-50' : ''
                                          ]">

                                        <!-- Priority Requested Badge -->
                                        <div x-show="ticket.priority_requested" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md z-10 whitespace-nowrap">
                                            <i class="fa-solid fa-bell fa-shake mr-1"></i> PRIORIDADE SOLICITADA
                                        </div>

                                        <div class="flex justify-between items-start mb-2 mt-1">
                                            <span class="font-mono text-gray-500 text-xs" x-text="'OS #' + ticket.os_number"></span>
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase" :class="getPriorityColor(ticket.priority)" x-text="ticket.priority"></span>
                                        </div>
                                        <h4 class="font-bold text-gray-900 text-sm mb-1 leading-tight" x-text="ticket.device_model"></h4>
                                        <p class="text-gray-500 text-xs mb-2 line-clamp-2" x-text="ticket.defect_reported"></p>

                                        <div class="mt-2 pt-2 border-t border-gray-50 space-y-1">
                                            <!-- Deadlines Section -->
                                            <div class="space-y-0.5 mb-2">
                                                <!-- Analysis Deadline -->
                                                <template x-if="ticket.analysis_deadline">
                                                    <div class="flex items-center justify-between text-[10px]">
                                                        <span class="font-bold text-gray-500 uppercase">Análise:</span>
                                                        <div class="flex items-center font-medium"
                                                             :class="new Date(ticket.analysis_deadline) < new Date() ? 'text-red-600 font-bold' : 'text-gray-500'">
                                                            <i class="fa-solid fa-stopwatch mr-1 text-[9px]"></i>
                                                            <span x-text="new Date(ticket.analysis_deadline).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' })"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Delivery Deadline -->
                                                <div class="flex items-center justify-between text-[10px]">
                                                    <span class="font-bold text-gray-500 uppercase">Entrega:</span>
                                                    <div class="flex items-center font-medium" :class="ticket.deadline && new Date(ticket.deadline) < new Date() ? 'text-red-600 font-bold' : 'text-gray-500'">
                                                        <i class="fa-regular fa-calendar-check mr-1 text-[9px]"></i>
                                                        <span x-text="ticket.deadline ? new Date(ticket.deadline).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' }) : 'S/ Prazo'"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="text-[10px] font-bold text-gray-600 truncate border-t border-gray-50 pt-1">
                                                Técnico: <span class="font-normal" x-text="getEmployeeName(ticket.technician_id)"></span>
                                            </div>
                                        </div>
                                     </div>
                                </template>
                                <div x-show="techTickets.filter(t => t.status === 'Analise Tecnica').length === 0" class="text-center py-10 text-gray-400 italic text-sm">
                                    Nenhum item em análise.
                                </div>
                            </div>
                        </div>

                        <!-- Col 2: Andamento Reparo -->
                        <div class="flex flex-col h-full overflow-hidden bg-gray-100 rounded-xl border border-gray-200">
                             <div class="p-3 border-b border-gray-200 bg-gray-200 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Em Andamento Reparo</h3>
                                <span class="bg-white text-gray-600 text-xs px-2 py-1 rounded-full font-bold shadow-sm" x-text="techTickets.filter(t => t.status === 'Andamento Reparo').length"></span>
                            </div>
                            <div class="p-4 overflow-y-auto space-y-4 kanban-col flex-grow">
                                <template x-for="ticket in techTickets.filter(t => t.status === 'Andamento Reparo' && matchesSearch(t))" :key="ticket.id">
                                     <div class="bg-white rounded-xl shadow border-t-4 p-4 relative cursor-pointer hover:shadow-md transition-shadow duration-500"
                                          @click="viewTicketDetails(ticket, 'tech')"
                                          :class="[
                                              ticket.priority_requested ? 'border-orange-500 ring-2 ring-orange-400' : (ticket.priority === 'Urgente' ? 'border-red-500' : (ticket.priority === 'Alta' ? 'border-orange-500' : 'border-blue-500')),
                                              (ticket.deadline && (new Date(ticket.deadline) - new Date()) > 0 && (new Date(ticket.deadline) - new Date()) < 3600000) ? 'animate-pulse ring-2 ring-red-400 ring-opacity-50' : ''
                                          ]">

                                        <!-- Priority Requested Badge -->
                                        <div x-show="ticket.priority_requested" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md z-10 whitespace-nowrap">
                                            <i class="fa-solid fa-bell fa-shake mr-1"></i> PRIORIDADE SOLICITADA
                                        </div>

                                        <div class="flex justify-between items-start mb-2 mt-1">
                                            <span class="font-mono text-gray-500 text-xs" x-text="'OS #' + ticket.os_number"></span>
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase" :class="getPriorityColor(ticket.priority)" x-text="ticket.priority"></span>
                                        </div>
                                        <h4 class="font-bold text-gray-900 text-sm mb-1 leading-tight" x-text="ticket.device_model"></h4>

                                        <!-- Timer -->
                                        <template x-if="ticket.repair_start_at">
                                            <div class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold mt-2 inline-flex items-center">
                                                <i class="fa-solid fa-stopwatch mr-1"></i>
                                                <span x-text="getDuration(ticket.repair_start_at)"></span>
                                            </div>
                                        </template>

                                        <div class="mt-2 pt-2 border-t border-gray-50 space-y-1">
                                            <!-- Deadlines Section -->
                                            <div class="space-y-0.5 mb-2">
                                                <!-- Analysis Deadline -->
                                                <template x-if="ticket.analysis_deadline">
                                                    <div class="flex items-center justify-between text-[10px]">
                                                        <span class="font-bold text-gray-500 uppercase">Análise:</span>
                                                        <div class="flex items-center text-gray-500 font-medium">
                                                            <i class="fa-solid fa-stopwatch mr-1 text-[9px]"></i>
                                                            <span x-text="new Date(ticket.analysis_deadline).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' })"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Delivery Deadline -->
                                                <div class="flex items-center justify-between text-[10px]">
                                                    <span class="font-bold text-gray-500 uppercase">Entrega:</span>
                                                    <div class="flex items-center font-medium" :class="ticket.deadline && new Date(ticket.deadline) < new Date() ? 'text-red-600' : 'text-gray-500'">
                                                        <i class="fa-regular fa-calendar-check mr-1 text-[9px]"></i>
                                                        <span x-text="ticket.deadline ? new Date(ticket.deadline).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' }) : 'S/ Prazo'"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="text-[10px] font-bold text-gray-600 truncate border-t border-gray-50 pt-1">
                                                Técnico: <span class="font-normal" x-text="getEmployeeName(ticket.technician_id)"></span>
                                            </div>
                                        </div>
                                     </div>
                                </template>
                                <div x-show="techTickets.filter(t => t.status === 'Andamento Reparo').length === 0" class="text-center py-10 text-gray-400 italic text-sm">
                                    Nenhum reparo em andamento.
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- VIEW: CONFIGURATION (Was Employees) -->
                <div x-show="(session || employeeSession) && view === 'employees'" class="max-w-7xl mx-auto p-8" x-cloak>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Configuração</h1>
                    </div>

                    <!-- Section 1: Company Data -->
                    <div class="bg-white rounded-lg shadow p-6 mb-8">
                         <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Dados da Empresa</h2>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                 <label class="block text-sm font-bold text-gray-600 mb-1">WhatsApp da Empresa</label>
                                 <p class="text-xs text-gray-400 mb-2">Este número aparecerá no botão "Precisa de Ajuda?" da página do cliente.</p>
                                 <div class="flex">
                                     <input type="text" x-model="whatsappNumber" placeholder="Ex: 5511999999999" class="flex-grow border rounded-l-lg p-2 bg-gray-50 focus:ring-2 focus:ring-brand-500 outline-none">
                                     <button @click="saveCompanyConfig()" class="bg-brand-500 text-white px-4 py-2 rounded-r-lg font-bold hover:bg-brand-600">Salvar</button>
                                 </div>
                             </div>
                         </div>
                    </div>

                    <!-- Section 2: Manage Team -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                             <h2 class="text-lg font-bold text-gray-800">Gerenciar Equipe</h2>
                             <div class="flex gap-2">
                                <button x-show="hasRole('admin')" @click="openRecycleBin()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors text-sm font-bold flex items-center">
                                    <i class="fa-solid fa-trash-arrow-up mr-2"></i> Lixeira
                                </button>
                                <button @click="openModal('newEmployee')" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 transition-colors text-sm">
                                    <i class="fa-solid fa-plus mr-2"></i> Novo Funcionário
                                </button>
                             </div>
                        </div>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuário</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Função</th>
                                    <th class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="emp in employees" :key="emp.id">
                                    <tr>
                                        <td class="px-6 py-4" x-text="emp.name"></td>
                                        <td class="px-6 py-4" x-text="emp.username"></td>
                                        <td class="px-6 py-4">
                                             <template x-for="role in emp.roles"><span class="px-2 bg-blue-100 text-blue-800 text-xs rounded-full mr-1" x-text="role"></span></template>
                                        </td>
                                        <td class="px-6 py-4 text-right space-x-2">
                                            <button @click="openEditEmployee(emp)" class="text-blue-600 hover:text-blue-900" title="Editar"><i class="fa-solid fa-pen"></i></button>
                                            <button @click="deleteEmployee(emp.id)" class="text-red-600 hover:text-red-900" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: LOGIN/REGISTER (If not logged in) -->
                <div x-show="!session && !employeeSession && !registrationSuccess && view !== 'setup_required'" class="absolute inset-0 bg-white z-50 overflow-y-auto" x-cloak>
                    <div class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                            <div class="text-center mb-8">
                                <img src="logologin.png" alt="TechAssist" class="h-[72px] mx-auto mb-4">
                                <h2 class="text-2xl font-bold text-gray-900">Acesso ao Sistema</h2>
                            </div>

                            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                                <button @click="authMode = 'employee'" :class="authMode === 'employee' ? 'bg-white shadow text-black' : 'text-gray-500 hover:text-gray-700'" class="flex-1 py-2 rounded-md text-sm font-bold transition-all">Funcionário</button>
                                <button @click="authMode = 'admin_login'" :class="authMode.includes('admin') ? 'bg-white shadow text-black' : 'text-gray-500 hover:text-gray-700'" class="flex-1 py-2 rounded-md text-sm font-bold transition-all">Admin</button>
                            </div>

                            <!-- Employee Form -->
                            <form x-show="authMode === 'employee'" @submit.prevent="loginEmployee" class="space-y-4">
                                <input type="text" x-model="loginForm.company_code" placeholder="Código da Empresa" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" required>
                                <input type="text" x-model="loginForm.username" placeholder="Usuário" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" required>
                                <input type="password" x-model="loginForm.password" placeholder="Senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" required>
                                <button type="submit" class="w-full bg-brand-500 text-white font-bold py-3 rounded-lg hover:bg-brand-600 transition-colors shadow-lg shadow-orange-500/30">Entrar</button>
                            </form>

                            <!-- Admin Form -->
                            <form x-show="authMode === 'admin_login'" @submit.prevent="loginAdmin" class="space-y-4">
                                <input type="email" x-model="adminForm.email" placeholder="E-mail Admin" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <input type="password" x-model="adminForm.password" placeholder="Senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <button type="submit" class="w-full bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-colors">Entrar Admin</button>
                                <p class="text-center text-sm text-gray-500 mt-4 cursor-pointer hover:text-brand-500" @click="authMode = 'admin_register'">Criar nova empresa</p>
                            </form>

                            <!-- Register Form -->
                             <form x-show="authMode === 'admin_register'" @submit.prevent="registerAdmin" class="space-y-4">
                                <input type="email" x-model="registerForm.email" placeholder="Seu E-mail" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <input type="password" x-model="registerForm.password" placeholder="Crie uma Senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black outline-none transition-all" required>
                                <button type="submit" class="w-full bg-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition-colors">Cadastrar</button>
                                <p class="text-center text-sm text-gray-500 mt-4 cursor-pointer hover:text-brand-500" @click="authMode = 'admin_login'">Voltar ao Login</p>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Setup Required Screen -->
                <div x-show="view === 'setup_required'" class="absolute inset-0 bg-white z-50 flex items-center justify-center" x-cloak>
                    <div class="max-w-md w-full p-8 text-center">
                        <h2 class="text-2xl font-bold mb-4">Bem-vindo!</h2>
                        <p class="mb-6">Para finalizar, qual o nome da sua assistência?</p>
                        <form @submit.prevent="completeCompanySetup">
                            <input type="text" x-model="registerForm.companyName" class="w-full border p-3 rounded mb-4" placeholder="Nome da Empresa" required>
                            <button type="submit" class="bg-black text-white w-full py-3 rounded font-bold">Começar</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- NOTIFICATIONS PANEL (Slide-over) -->
    <div x-show="modals.notifications" class="fixed inset-0 z-[100] overflow-hidden" x-cloak>
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute inset-0 bg-gray-900 bg-opacity-75 transition-opacity" @click="modals.notifications = false"></div>
            <div class="fixed inset-y-0 right-0 pl-10 max-w-full flex">
                <div class="w-screen max-w-md transform transition ease-in-out duration-500 sm:duration-700 translate-x-0" x-transition:enter="translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="translate-x-0" x-transition:leave-end="translate-x-full">
                    <div class="h-full flex flex-col bg-white shadow-xl overflow-y-scroll">
                        <div class="p-6 bg-black text-white">
                            <div class="flex items-start justify-between">
                                <h2 class="text-lg font-medium">Notificações</h2>
                                <button @click="modals.notifications = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                            </div>
                            <div class="mt-4 flex space-x-2">
                                <button @click="markAllRead()" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded transition-colors">Marcar todas lidas</button>
                                <label class="flex items-center space-x-2 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" x-model="showReadNotifications" class="rounded bg-gray-700 border-none">
                                    <span>Mostrar lidas</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex-1 p-6 space-y-4 bg-gray-50">
                            <template x-for="notif in notificationsList.filter(n => showReadNotifications || !n.is_read)" :key="notif.id">
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 relative group transition-all hover:shadow-md"
                                     :class="{
                                        'border-blue-500': notif.type === 'info',
                                        'border-orange-500': notif.type === 'warning',
                                        'border-red-600': notif.type === 'urgent',
                                        'opacity-60': notif.is_read
                                     }">
                                    <div class="flex justify-between items-start">
                                        <div class="flex items-start space-x-3">
                                            <div class="mt-0.5">
                                                <i class="fa-solid"
                                                   :class="{
                                                       'fa-circle-info text-blue-500': notif.type === 'info',
                                                       'fa-triangle-exclamation text-orange-500': notif.type === 'warning',
                                                       'fa-bell fa-shake text-red-600': notif.type === 'urgent'
                                                   }"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm font-bold text-gray-800" x-text="notif.message"></p>
                                                <p class="text-xs text-gray-500 mt-1" x-text="new Date(notif.created_at).toLocaleString()"></p>
                                                <template x-if="notif.tickets">
                                                    <p class="text-xs font-mono text-gray-400 mt-1" x-text="'Ref: OS ' + notif.tickets.os_number"></p>
                                                </template>
                                            </div>
                                        </div>
                                        <button x-show="!notif.is_read" @click="markNotificationRead(notif.id)" class="text-gray-300 hover:text-brand-500" title="Marcar como lida">
                                            <i class="fa-solid fa-check"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <div x-show="notificationsList.filter(n => showReadNotifications || !n.is_read).length === 0" class="text-center text-gray-400 py-10">
                                <i class="fa-regular fa-bell-slash text-4xl mb-2"></i>
                                <p>Nenhuma notificação.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 1.1 EDIT EMPLOYEE MODAL -->
    <div x-show="modals.editEmployee" class="fixed inset-0 z-[60] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.editEmployee = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <!-- Header -->
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Editar Funcionário</h3>
                    <button @click="modals.editEmployee = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <!-- Body -->
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nome Completo</label>
                            <input type="text" x-model="employeeForm.name" class="w-full border rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nome de Usuário</label>
                            <input type="text" x-model="employeeForm.username" class="w-full border rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Senha (Visível)</label>
                            <input type="text" x-model="employeeForm.password" class="w-full border rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" placeholder="Deixe vazio para manter a atual">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">Permissões (Funções)</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="tecnico" x-model="employeeForm.roles" class="text-brand-600 focus:ring-brand-500 h-4 w-4">
                                    <span class="text-sm">Técnico</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="atendente" x-model="employeeForm.roles" class="text-brand-600 focus:ring-brand-500 h-4 w-4">
                                    <span class="text-sm">Atendente</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="admin" x-model="employeeForm.roles" class="text-brand-600 focus:ring-brand-500 h-4 w-4">
                                    <span class="text-sm">Admin</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button @click="modals.editEmployee = false" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg transition-colors">Cancelar</button>
                    <button @click="updateEmployee()" class="px-6 py-2 bg-brand-500 text-white font-bold rounded-lg hover:bg-brand-600 shadow-lg shadow-orange-500/30 transition-colors">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- 1. NEW EMPLOYEE MODAL -->
    <div x-show="modals.newEmployee" class="fixed inset-0 z-[60] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.newEmployee = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <!-- Header -->
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Novo Funcionário</h3>
                    <button @click="modals.newEmployee = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <!-- Body -->
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nome Completo</label>
                            <input type="text" x-model="employeeForm.name" class="w-full border rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nome de Usuário</label>
                            <input type="text" x-model="employeeForm.username" class="w-full border rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Senha</label>
                            <input type="password" x-model="employeeForm.password" class="w-full border rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">Permissões (Funções)</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="tecnico" x-model="employeeForm.roles" class="text-brand-600 focus:ring-brand-500 h-4 w-4">
                                    <span class="text-sm">Técnico</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="atendente" x-model="employeeForm.roles" class="text-brand-600 focus:ring-brand-500 h-4 w-4">
                                    <span class="text-sm">Atendente</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="admin" x-model="employeeForm.roles" class="text-brand-600 focus:ring-brand-500 h-4 w-4">
                                    <span class="text-sm">Admin</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button @click="modals.newEmployee = false" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg transition-colors">Cancelar</button>
                    <button @click="createEmployee()" class="px-6 py-2 bg-brand-500 text-white font-bold rounded-lg hover:bg-brand-600 shadow-lg shadow-orange-500/30 transition-colors">Criar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. NEW TICKET MODAL -->
    <div x-show="modals.ticket" class="fixed inset-0 z-[60] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.ticket = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <!-- Header -->
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Novo Chamado</h3>
                    <button @click="modals.ticket = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <!-- Body -->
                <div class="p-6 max-h-[70vh] overflow-y-auto">
                    <!-- Section 1: Basic Info -->
                    <h4 class="text-sm font-bold text-brand-500 uppercase tracking-wide mb-4 border-b pb-2">Informações do Cliente e Aparelho</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Cliente *</label>
                            <input type="text" x-model="ticketForm.client_name" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Contato</label>
                            <input type="text" x-model="ticketForm.contact" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nº OS (Manual) *</label>
                            <input type="text" x-model="ticketForm.os_number" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Prioridade</label>
                            <select x-model="ticketForm.priority" class="w-full border rounded-lg p-2.5 bg-gray-50">
                                <template x-for="p in PRIORITIES"><option :value="p" x-text="p"></option></template>
                            </select>
                        </div>
                        <div x-data="{ open: false, search: '' }">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Modelo *</label>
                            <div class="relative">
                                <!-- Trigger Button (Looks like Select) -->
                                <button @click="open = !open; search = ''; $nextTick(() => $refs.searchInput.focus())"
                                        type="button"
                                        class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-left flex justify-between items-center focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                                    <span x-text="ticketForm.model || 'Selecione o Modelo...'" :class="!ticketForm.model ? 'text-gray-400' : 'text-gray-900'"></span>
                                    <i class="fa-solid fa-chevron-down text-xs text-gray-500"></i>
                                </button>

                                <!-- Dropdown -->
                                <div x-show="open" @click.outside="open = false"
                                     class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm"
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="transform opacity-0 scale-95"
                                     x-transition:enter-end="transform opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="transform opacity-100 scale-100"
                                     x-transition:leave-end="transform opacity-0 scale-95"
                                     x-cloak>

                                    <!-- Search Input -->
                                    <div class="sticky top-0 z-10 bg-white p-2 border-b">
                                        <div class="flex gap-1">
                                            <input x-ref="searchInput" x-model="search" type="text"
                                                   class="w-full p-2 border rounded text-sm focus:ring-brand-500 focus:border-brand-500"
                                                   placeholder="Buscar ou criar...">

                                            <!-- Add Button (Visible if search has text) -->
                                            <button x-show="search.length > 0 && !deviceModels.some(m => m.name.toLowerCase() === search.toLowerCase())"
                                                    @click="createDeviceModel(search).then(ok => { if(ok) { ticketForm.model = search; open = false; search = ''; } })"
                                                    class="bg-brand-500 text-white px-3 rounded hover:bg-brand-600 transition-colors" title="Cadastrar">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- List -->
                                    <ul class="py-1">
                                        <template x-for="model in deviceModels.filter(m => m.name.toLowerCase().includes(search.toLowerCase()))" :key="model.id">
                                            <li class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-100 group flex justify-between items-center"
                                                @click="ticketForm.model = model.name; open = false">
                                                <span class="block truncate" :class="ticketForm.model === model.name ? 'font-bold text-brand-600' : 'text-gray-900'" x-text="model.name"></span>

                                                <!-- Delete Icon -->
                                                <button @click.stop="deleteDeviceModel(model.id)" class="mr-2 text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i class="fa-solid fa-trash text-xs"></i>
                                                </button>
                                            </li>
                                        </template>

                                        <!-- No Results -->
                                        <li x-show="deviceModels.filter(m => m.name.toLowerCase().includes(search.toLowerCase())).length === 0" class="text-gray-500 p-4 text-center italic text-xs">
                                            <span x-show="search.length === 0">Comece a digitar...</span>
                                            <span x-show="search.length > 0">Clique no + para criar.</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                         <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nº Série / IMEI</label>
                            <input type="text" x-model="ticketForm.serial" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Prazo de Análise</label>
                            <input type="datetime-local" x-model="ticketForm.analysis_deadline" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Prazo de Entrega</label>
                            <input type="datetime-local" x-model="ticketForm.deadline" class="w-full border rounded-lg p-2.5 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Situação do Aparelho</label>
                            <input type="text" x-model="ticketForm.device_condition" class="w-full border rounded-lg p-2.5 bg-gray-50" placeholder="Ex: Riscos na tela...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Técnico Responsável *</label>
                            <select x-model="ticketForm.technician_id" class="w-full border rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all">
                                <option value="">-- Selecione um Técnico --</option>
                                <option value="all">TODOS (Disponível para equipe)</option>
                                <template x-for="tech in getTechnicians()" :key="tech.id">
                                    <option :value="tech.id" x-text="tech.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="col-span-2" x-data="{ open: false, search: '' }">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Defeito Relatado *</label>

                            <!-- Selected Tags -->
                            <div class="flex flex-wrap gap-2 mb-2" x-show="ticketForm.defects && ticketForm.defects.length > 0">
                                <template x-for="defect in ticketForm.defects" :key="defect">
                                    <span class="bg-gray-200 text-gray-800 text-xs font-bold px-2 py-1 rounded flex items-center border border-gray-300">
                                        <span x-text="defect"></span>
                                        <button @click="removeDefectFromTicket(defect)" class="ml-2 text-gray-500 hover:text-red-500 transition-colors">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </span>
                                </template>
                            </div>

                            <!-- Dropdown Trigger -->
                            <div class="relative">
                                <button type="button"
                                        @click="open = !open; search = ''; $nextTick(() => $refs.defectSearch.focus())"
                                        class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-left flex justify-between items-center focus:ring-2 focus:ring-brand-500 focus:border-brand-500 text-sm transition-all"
                                        :class="ticketForm.defects && ticketForm.defects.length > 0 ? 'text-gray-900' : 'text-gray-400'">
                                    <span x-text="ticketForm.defects && ticketForm.defects.length > 0 ? 'Adicionar outro defeito...' : 'Selecione ou digite os defeitos...'"></span>
                                    <i class="fa-solid fa-chevron-down text-xs text-gray-500"></i>
                                </button>

                                <!-- Dropdown Menu -->
                                <div x-show="open" @click.outside="open = false"
                                     class="absolute z-10 mt-1 w-full bg-white shadow-xl max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm"
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="transform opacity-0 scale-95"
                                     x-transition:enter-end="transform opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="transform opacity-100 scale-100"
                                     x-transition:leave-end="transform opacity-0 scale-95"
                                     x-cloak>

                                     <!-- Search Input -->
                                     <div class="sticky top-0 z-10 bg-white p-2 border-b">
                                         <div class="flex gap-1">
                                             <input x-ref="defectSearch" x-model="search" type="text"
                                                    class="w-full p-2 border rounded text-sm focus:ring-brand-500 focus:border-brand-500"
                                                    placeholder="Buscar ou criar novo..."
                                                    @keydown.enter.prevent="if(search.length > 0 && !defectOptions.some(d => d.name.toLowerCase() === search.toLowerCase())) { createDefectOption(search).then(ok => { if(ok) { addDefectToTicket(search); open = false; search = ''; } }); }">

                                             <!-- Add Button -->
                                             <button x-show="search.length > 0 && !defectOptions.some(d => d.name.toLowerCase() === search.toLowerCase())"
                                                     @click.prevent="createDefectOption(search).then(ok => { if(ok) { addDefectToTicket(search); open = false; search = ''; } })"
                                                     class="bg-brand-500 text-white px-3 rounded hover:bg-brand-600 transition-colors shadow" title="Cadastrar Defeito">
                                                 <i class="fa-solid fa-plus"></i>
                                             </button>
                                         </div>
                                     </div>

                                     <!-- List -->
                                     <ul class="py-1">
                                         <template x-for="option in defectOptions.filter(d => d.name.toLowerCase().includes(search.toLowerCase()))" :key="option.id">
                                             <li class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-100 group flex justify-between items-center transition-colors"
                                                 @click="addDefectToTicket(option.name); open = false">
                                                 <span class="block truncate" :class="ticketForm.defects.includes(option.name) ? 'font-bold text-brand-600' : 'text-gray-900'" x-text="option.name"></span>

                                                 <!-- Delete Option -->
                                                 <button @click.stop="deleteDefectOption(option.id)" class="mr-2 text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir Opção">
                                                    <i class="fa-solid fa-trash text-xs"></i>
                                                 </button>
                                             </li>
                                         </template>

                                         <!-- No Results -->
                                         <li x-show="defectOptions.filter(d => d.name.toLowerCase().includes(search.toLowerCase())).length === 0" class="text-gray-500 p-4 text-center italic text-xs">
                                             <span x-show="search.length === 0">Comece a digitar para buscar...</span>
                                             <span x-show="search.length > 0">Clique no + para cadastrar.</span>
                                         </li>
                                     </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Checklist -->
                    <div class="mb-6">
                        <div class="flex justify-between items-end border-b pb-2 mb-4">
                            <h4 class="text-sm font-bold text-brand-500 uppercase tracking-wide">Checklist de Entrada</h4>
                            <div class="flex items-center space-x-2">
                                <select x-model="selectedTemplateId" @change="loadTemplate()" class="text-xs border rounded p-1">
                                    <option value="">Carregar Modelo...</option>
                                    <template x-for="t in checklistTemplatesEntry" :key="t.id">
                                        <option :value="t.id" x-text="t.name"></option>
                                    </template>
                                </select>
                                <button x-show="selectedTemplateId" @click="deleteTemplate()" class="text-red-500 hover:text-red-700 p-1" title="Excluir Modelo">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Add Item -->
                        <div class="flex space-x-2 mb-3">
                            <input type="text" x-model="newChecklistItem" @keydown.enter.prevent="addChecklistItem" placeholder="Novo item (ex: Tela trincada?)" class="flex-grow border rounded p-2 text-sm">
                            <button @click="addChecklistItem" class="bg-gray-200 px-3 rounded hover:bg-gray-300"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        <!-- List -->
                        <div class="space-y-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                             <template x-for="(item, idx) in ticketForm.checklist" :key="idx">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" x-model="item.ok" class="text-brand-600 focus:ring-brand-500">
                                        <span class="text-sm font-medium" :class="item.ok ? 'line-through text-gray-400' : 'text-gray-800'" x-text="item.item"></span>
                                    </div>
                                    <button @click="removeChecklistItem(idx)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </template>
                            <div x-show="ticketForm.checklist.length === 0" class="text-center text-gray-400 text-sm italic">Nenhum item no checklist.</div>
                        </div>

                        <!-- Save Template -->
                        <div class="mt-2 flex items-center space-x-2 justify-end">
                            <input type="text" x-model="newTemplateName" placeholder="Nome para salvar modelo" class="text-xs border rounded p-1 w-40">
                            <button @click="saveTemplate()" class="text-xs bg-gray-800 text-white px-2 py-1 rounded">Salvar Modelo</button>
                        </div>
                    </div>

                    <!-- Section 3: Final Checklist -->
                    <div class="mb-6">
                        <div class="flex justify-between items-end border-b pb-2 mb-4">
                            <h4 class="text-sm font-bold text-brand-500 uppercase tracking-wide">Checklist de Saída</h4>
                            <div class="flex items-center space-x-2">
                                <select x-model="selectedTemplateIdFinal" @change="loadTemplateFinal()" class="text-xs border rounded p-1">
                                    <option value="">Carregar Modelo...</option>
                                    <template x-for="t in checklistTemplatesFinal" :key="t.id">
                                        <option :value="t.id" x-text="t.name"></option>
                                    </template>
                                </select>
                                <button x-show="selectedTemplateIdFinal" @click="deleteTemplateFinal()" class="text-red-500 hover:text-red-700 p-1" title="Excluir Modelo">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Add Item -->
                        <div class="flex space-x-2 mb-3">
                            <input type="text" x-model="newChecklistFinalItem" @keydown.enter.prevent="addChecklistFinalItem" placeholder="Novo item (ex: Tela limpa?)" class="flex-grow border rounded p-2 text-sm">
                            <button @click="addChecklistFinalItem" class="bg-gray-200 px-3 rounded hover:bg-gray-300"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        <!-- List -->
                        <div class="space-y-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                             <template x-for="(item, idx) in ticketForm.checklist_final" :key="idx">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <i class="fa-regular fa-square text-gray-400"></i>
                                        <span class="text-sm font-medium text-gray-800" x-text="item.item"></span>
                                    </div>
                                    <button @click="removeChecklistFinalItem(idx)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </template>
                            <div x-show="ticketForm.checklist_final.length === 0" class="text-center text-gray-400 text-sm italic">Nenhum item no checklist final.</div>
                        </div>

                        <!-- Save Template -->
                        <div class="mt-2 flex items-center space-x-2 justify-end">
                            <input type="text" x-model="newTemplateNameFinal" placeholder="Nome para salvar modelo" class="text-xs border rounded p-1 w-40">
                            <button @click="saveTemplateFinal()" class="text-xs bg-gray-800 text-white px-2 py-1 rounded">Salvar Modelo</button>
                        </div>
                    </div>

                    <!-- Section 4: Photos -->
                     <div>
                        <h4 class="text-sm font-bold text-brand-500 uppercase tracking-wide mb-2 border-b pb-2">Fotos</h4>
                        <div class="mb-3">
                            <label class="cursor-pointer bg-gray-100 border border-gray-300 hover:bg-gray-200 text-gray-700 text-xs font-bold py-2 px-4 rounded inline-flex items-center transition-colors">
                                <i class="fa-solid fa-camera mr-2"></i> Adicionar Fotos
                                <input type="file" multiple accept="image/*" class="hidden" @change="handlePhotoUpload($event, 'new')">
                            </label>
                            <span x-show="loading" class="text-xs text-gray-400 ml-2 animate-pulse">Enviando...</span>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <template x-for="(url, idx) in ticketForm.photos" :key="idx">
                                <div class="relative group aspect-square">
                                    <img :src="url" class="w-full h-full object-cover rounded-lg border border-gray-200 cursor-pointer" @click="window.open(url, '_blank')">
                                    <button @click="removePhoto(idx, 'new')" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button @click="modals.ticket = false" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg transition-colors">Cancelar</button>
                    <button @click="createTicket()" class="px-6 py-2 bg-brand-500 text-white font-bold rounded-lg hover:bg-brand-600 shadow-lg shadow-orange-500/30 transition-colors">Criar Chamado</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. VIEW/EDIT TICKET MODAL -->
    <div x-show="modals.viewTicket" class="fixed inset-0 z-[70] overflow-y-auto" x-cloak>
         <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.viewTicket = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">

                <template x-if="selectedTicket">
                <div>
                     <!-- Header with Status Actions -->
                    <div class="bg-white border-b px-6 py-4 flex justify-between items-start">
                        <div>
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="bg-black text-white text-xs font-bold px-2 py-1 rounded font-mono" x-text="'OS #' + selectedTicket.os_number"></span>
                                <span class="text-xs font-bold px-2 py-1 rounded uppercase" :class="getPriorityColor(selectedTicket.priority)" x-text="selectedTicket.priority"></span>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900" x-text="selectedTicket.device_model"></h2>
                            <p class="text-gray-500 text-sm" x-text="selectedTicket.client_name"></p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <div class="flex items-center space-x-2">
                                <!-- Share Button (New) -->
                                <button @click="openShareModal()" class="text-xs bg-brand-500 text-white px-2 py-1 rounded hover:bg-brand-600 font-bold transition-colors">
                                    <i class="fa-solid fa-share-nodes mr-1"></i> Compartilhar
                                </button>
                                <!-- Logs Button (Admin Only) -->
                                <template x-if="hasRole('admin')">
                                    <button @click="openLogs(selectedTicket)" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300 font-bold transition-colors">
                                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> Histórico
                                    </button>
                                </template>
                            </div>
                             <div class="text-lg font-bold text-brand-600 mt-1" x-text="getStatusLabel(selectedTicket.status)"></div>
                        </div>
                    </div>

                    <!-- Action Bar (Logic for Buttons) -->
                    <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">

                        <!-- 1. Aberto -> Analise -->
                        <template x-if="selectedTicket.status === 'Aberto'">
                            <button @click="updateStatus(selectedTicket, 'Analise Tecnica', {}, { action: 'Iniciou Atendimento', details: 'Moveu para Análise Técnica' })" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 text-sm shadow flex items-center">
                                <i class="fa-solid fa-microscope mr-2"></i> Iniciar Atendimento (Ir para Análise)
                            </button>
                        </template>

                        <!-- 2. Analise -> Aprovação -->
                        <template x-if="selectedTicket.status === 'Analise Tecnica' && modalSource === 'tech'">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-2">Conclusão da Análise</h4>
                                <div class="mb-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" x-model="analysisForm.needsParts" class="form-checkbox text-blue-600 h-5 w-5">
                                        <span class="text-sm font-bold text-gray-700">Precisa comprar peças?</span>
                                    </label>
                                </div>
                                <div x-show="analysisForm.needsParts" class="mb-3">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Quais peças?</label>
                                    <input type="text" x-model="analysisForm.partsList" class="w-full border rounded p-2 text-sm" placeholder="Ex: Tela, Bateria...">
                                </div>
                                <button @click="finishAnalysis()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 text-sm w-full">
                                    Finalizar e Enviar para Aprovação
                                </button>
                            </div>
                        </template>

                        <!-- 3. Aprovação Flow -->
                        <template x-if="selectedTicket.status === 'Aprovacao'">
                            <div class="flex space-x-3 items-center">
                                <!-- Send Budget Button -->
                                <button @click="sendBudget()"
                                        :disabled="selectedTicket.budget_status === 'Enviado'"
                                        class="px-4 py-2 rounded font-bold text-sm shadow transition-colors"
                                        :class="selectedTicket.budget_status === 'Enviado' ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-yellow-500 text-white hover:bg-yellow-600'">
                                    <i class="fa-solid fa-file-invoice-dollar mr-2"></i>
                                    <span x-text="selectedTicket.budget_status === 'Enviado' ? 'Orçamento Enviado' : 'Enviar Orçamento'"></span>
                                </button>

                                <div class="h-8 w-px bg-gray-300 mx-2"></div>

                                <!-- Approve/Deny (Locked until budget sent) -->
                                <button @click="approveRepair()"
                                        :disabled="selectedTicket.budget_status !== 'Enviado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.budget_status !== 'Enviado' ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'">
                                    <i class="fa-solid fa-check mr-1"></i> Aprovar
                                </button>

                                <button @click="denyRepair()"
                                        :disabled="selectedTicket.budget_status !== 'Enviado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.budget_status !== 'Enviado' ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-red-600 text-white hover:bg-red-700'">
                                    <i class="fa-solid fa-xmark mr-1"></i> Negar
                                </button>
                            </div>
                        </template>

                        <!-- 4. Compra Flow -->
                        <template x-if="selectedTicket.status === 'Compra Peca'">
                            <div class="flex space-x-3 items-center">
                                <button @click="markPurchased()"
                                        :disabled="selectedTicket.parts_status === 'Comprado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.parts_status === 'Comprado' ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-purple-600 text-white hover:bg-purple-700'">
                                    <i class="fa-solid fa-cart-shopping mr-2"></i>
                                    <span x-text="selectedTicket.parts_status === 'Comprado' ? 'Peça Comprada' : 'Confirmar Compra'"></span>
                                </button>

                                <div class="h-8 w-px bg-gray-300 mx-2"></div>

                                <button @click="confirmReceived()"
                                        :disabled="selectedTicket.parts_status !== 'Comprado'"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.parts_status !== 'Comprado' ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-teal-600 text-white hover:bg-teal-700'">
                                    <i class="fa-solid fa-box-open mr-1"></i> Recebido (Iniciar Reparo)
                                </button>
                            </div>
                        </template>

                        <!-- 5. Reparo Flow -->
                        <template x-if="selectedTicket.status === 'Andamento Reparo' && modalSource === 'tech'">
                            <div class="w-full">
                                <div class="flex space-x-3 mb-2">
                                    <button @click="startRepair()"
                                            x-show="!selectedTicket.repair_start_at"
                                            class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 text-sm shadow flex-grow">
                                        <i class="fa-solid fa-screwdriver-wrench mr-2"></i> Iniciar Execução
                                    </button>

                                    <button @click="openOutcomeModal('repair')"
                                            x-show="selectedTicket.repair_start_at"
                                            class="bg-orange-500 text-white px-4 py-2 rounded font-bold hover:bg-orange-600 text-sm shadow flex-grow">
                                        <i class="fa-solid fa-flag-checkered mr-2"></i> Finalizar Reparo
                                    </button>
                                </div>
                                <div x-show="selectedTicket.repair_start_at" class="text-center bg-gray-100 rounded p-1">
                                    <span class="text-xs text-gray-500 font-bold uppercase">Tempo Decorrido</span>
                                    <div class="text-xl font-mono font-bold text-gray-800" x-text="getDuration(selectedTicket.repair_start_at)"></div>
                                </div>
                            </div>
                        </template>

                        <!-- 6. Teste Final Flow -->
                         <template x-if="selectedTicket.status === 'Teste Final'">
                            <div class="flex space-x-3">
                                 <button @click="startTest()"
                                         x-show="!selectedTicket.test_start_at"
                                         class="bg-indigo-500 text-white px-4 py-2 rounded font-bold hover:bg-indigo-600 text-sm shadow">
                                    <i class="fa-solid fa-vial mr-2"></i> Iniciar Testes
                                </button>

                                <button @click="openOutcomeModal('test')"
                                        x-show="selectedTicket.test_start_at"
                                        class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 text-sm shadow">
                                    <i class="fa-solid fa-clipboard-check mr-2"></i> Concluir Testes
                                </button>
                            </div>
                        </template>

                        <!-- 7. Retirada Flow -->
                        <template x-if="selectedTicket.status === 'Retirada Cliente'">
                             <div class="flex space-x-3 items-center">
                                <button @click="markAvailable()"
                                        :disabled="selectedTicket.pickup_available"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="selectedTicket.pickup_available ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'">
                                    <i class="fa-solid fa-bell mr-2"></i>
                                    <span x-text="selectedTicket.pickup_available ? 'Cliente Avisado' : 'Disponível p/ Retirada'"></span>
                                </button>

                                <div class="h-8 w-px bg-gray-300 mx-2"></div>

                                <button @click="confirmPickup()"
                                        :disabled="!selectedTicket.pickup_available"
                                        class="px-4 py-2 rounded font-bold text-sm transition-colors"
                                        :class="!selectedTicket.pickup_available ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gray-800 text-white hover:bg-black'">
                                    <i class="fa-solid fa-handshake mr-1"></i> Retirado (Finalizar)
                                </button>
                            </div>
                        </template>

                        <!-- 8. Finalizado -->
                        <template x-if="selectedTicket.status === 'Finalizado'">
                            <div class="text-center w-full py-2">
                                <span class="px-4 py-2 rounded-full font-bold text-white text-sm"
                                      :class="selectedTicket.repair_successful ? 'bg-green-500' : 'bg-red-500'">
                                      <i class="fa-solid" :class="selectedTicket.repair_successful ? 'fa-check' : 'fa-xmark'"></i>
                                      <span x-text="selectedTicket.repair_successful ? 'Concluído com Sucesso' : 'Concluído sem Sucesso'"></span>
                                </span>
                            </div>
                        </template>

                    </div>

                    <!-- Details Body -->
                    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 max-h-[60vh] overflow-y-auto">

                        <!-- Left: Info -->
                        <div class="col-span-1 space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <h4 class="font-bold text-gray-700 text-xs uppercase mb-2">Dados do Aparelho</h4>
                                <div class="grid grid-cols-1 gap-2 mb-3">
                                    <p class="text-sm"><span class="font-bold text-gray-600">Serial:</span> <span x-text="selectedTicket.serial_number || '-'"></span></p>
                                    <p class="text-sm"><span class="font-bold text-gray-600">Condição:</span> <span x-text="selectedTicket.device_condition || '-'"></span></p>
                                    <p class="text-sm"><span class="font-bold text-gray-600">Técnico:</span> <span class="bg-black text-white px-2 py-0.5 rounded text-xs" x-text="getEmployeeName(selectedTicket.technician_id)"></span></p>

                                    <!-- Editable Deadlines Container -->
                                    <div class="mt-2 p-2 bg-white rounded border border-gray-200">
                                        <div class="flex justify-between items-center mb-1">
                                            <h5 class="text-xs font-bold uppercase text-gray-500">Prazos</h5>
                                            <div x-show="!editingDeadlines">
                                                <button @click="startEditingDeadlines()" class="text-gray-400 hover:text-brand-500 transition-colors" title="Editar Prazos">
                                                    <i class="fa-solid fa-pen text-xs"></i>
                                                </button>
                                            </div>
                                            <div x-show="editingDeadlines" class="flex space-x-2">
                                                <button @click="saveDeadlines()" class="text-green-500 hover:text-green-700"><i class="fa-solid fa-check"></i></button>
                                                <button @click="cancelEditingDeadlines()" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-xmark"></i></button>
                                            </div>
                                        </div>

                                        <!-- Display Mode -->
                                        <div x-show="!editingDeadlines" class="space-y-1">
                                            <p class="text-sm flex justify-between">
                                                <span class="font-bold text-gray-600">Análise:</span>
                                                <span x-text="selectedTicket.analysis_deadline ? new Date(selectedTicket.analysis_deadline).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : '-'"
                                                      :class="new Date(selectedTicket.analysis_deadline) < new Date() ? 'text-red-600 font-bold' : 'text-gray-800'"></span>
                                            </p>
                                            <p class="text-sm flex justify-between">
                                                <span class="font-bold text-gray-600">Entrega:</span>
                                                <span x-text="selectedTicket.deadline ? new Date(selectedTicket.deadline).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : '-'"
                                                      :class="new Date(selectedTicket.deadline) < new Date() ? 'text-red-600 font-bold' : 'text-gray-800'"></span>
                                            </p>
                                        </div>

                                        <!-- Edit Mode -->
                                        <div x-show="editingDeadlines" class="space-y-2 mt-2">
                                            <div>
                                                <label class="block text-[10px] font-bold text-gray-500">Análise</label>
                                                <input type="datetime-local" x-model="editDeadlineForm.analysis_deadline" class="w-full border rounded p-1 text-xs">
                                            </div>
                                            <div>
                                                <label class="block text-[10px] font-bold text-gray-500">Entrega</label>
                                                <input type="datetime-local" x-model="editDeadlineForm.deadline" class="w-full border rounded p-1 text-xs">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-sm mb-1 font-bold text-gray-700">Defeito Inicial:</p>
                                <p class="text-sm text-gray-600 bg-white p-2 rounded border mb-2" x-text="selectedTicket.defect_reported"></p>

                                <template x-if="selectedTicket.test_notes && selectedTicket.test_notes.length > 0">
                                    <div>
                                        <p class="text-sm mb-1 font-bold text-gray-700">Histórico de Testes:</p>
                                        <div class="space-y-2">
                                            <template x-for="(note, idx) in selectedTicket.test_notes" :key="idx">
                                                <div class="p-2 rounded border bg-white">
                                                    <p class="text-xs text-gray-400 mb-1" x-text="new Date(note.date).toLocaleDateString() + ' - ' + note.user"></p>
                                                    <p :class="idx === selectedTicket.test_notes.length - 1 ? 'text-lg font-bold text-brand-500' : 'text-sm text-gray-600'" x-text="note.text"></p>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                             <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <h4 class="font-bold text-gray-700 text-xs uppercase mb-2">Cliente</h4>
                                <p class="text-sm mb-1"><span class="font-bold">Nome:</span> <span x-text="selectedTicket.client_name"></span></p>
                                <p class="text-sm mb-1 flex items-center">
                                    <span class="font-bold mr-2">Contato:</span>
                                    <button @click="openWhatsApp(selectedTicket.contact_info)" class="text-green-600 hover:text-green-800 font-bold flex items-center transition-colors" title="Abrir WhatsApp">
                                        <span x-text="selectedTicket.contact_info || '-'"></span>
                                        <i x-show="selectedTicket.contact_info" class="fa-brands fa-whatsapp ml-2"></i>
                                    </button>
                                </p>
                            </div>
                        </div>

                        <!-- Center: Technical & Checklist -->
                        <div class="col-span-2 space-y-4">

                            <!-- Tech Notes -->
                            <div class="border rounded-lg p-4">
                                <h4 class="font-bold text-brand-600 text-sm uppercase mb-2"> <i class="fa-solid fa-pen-to-square mr-1"></i> Análise Técnica</h4>
                                <textarea x-model="selectedTicket.tech_notes" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-brand-500 focus:ring-brand-500" rows="3" placeholder="Relatório técnico..."></textarea>

                                <div class="mt-3">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Peças Necessárias</label>
                                    <input type="text" x-model="selectedTicket.parts_needed" class="w-full text-sm border-gray-300 rounded-md" placeholder="Ex: Tela, Bateria...">
                                </div>

                                <!-- Photos in Tech Notes -->
                                <div class="mt-4 border-t pt-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-bold text-gray-500 uppercase">Fotos do Aparelho</label>
                                        <label class="cursor-pointer text-brand-600 hover:text-brand-800 text-xs font-bold flex items-center">
                                            <i class="fa-solid fa-plus mr-1"></i> Adicionar
                                            <input type="file" multiple accept="image/*" class="hidden" @change="handlePhotoUpload($event, 'existing')">
                                        </label>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <template x-for="(url, idx) in selectedTicket.photos_urls" :key="idx">
                                            <div class="relative group aspect-square">
                                                <img :src="url" class="w-full h-full object-cover rounded border border-gray-200 cursor-pointer" @click="window.open(url, '_blank')">
                                                <button @click="removePhoto(idx, 'existing')" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <i class="fa-solid fa-times"></i>
                                                </button>
                                            </div>
                                        </template>
                                        <div x-show="!selectedTicket.photos_urls || selectedTicket.photos_urls.length === 0" class="col-span-4 text-center py-4 text-gray-400 text-xs italic bg-gray-50 rounded">
                                            Sem fotos.
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3 text-right">
                                    <button @click="saveTicketChanges()" class="text-xs bg-gray-800 text-white px-3 py-1 rounded hover:bg-black">Salvar Anotações</button>
                                </div>
                            </div>

                            <!-- Checklists Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Checklist Inicial -->
                                <div class="border rounded-lg p-4 bg-gray-50">
                                    <h4 class="font-bold text-gray-600 text-sm uppercase mb-2">Checklist Entrada</h4>
                                    <div class="space-y-2">
                                        <template x-for="(item, idx) in selectedTicket.checklist_data">
                                            <div class="flex items-center space-x-2 bg-white p-2 rounded border">
                                                 <input type="checkbox" x-model="item.ok" :disabled="true" class="text-brand-600 focus:ring-brand-500 disabled:opacity-50">
                                                 <span class="text-sm" x-text="item.item"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div x-show="!selectedTicket.checklist_data || selectedTicket.checklist_data.length === 0" class="text-gray-400 text-sm italic">Vazio.</div>
                                </div>

                                <!-- Checklist Final -->
                                <div class="border rounded-lg p-4 bg-gray-50"
                                     x-show="['Teste Final', 'Retirada Cliente', 'Finalizado'].includes(selectedTicket.status)">
                                    <h4 class="font-bold text-brand-600 text-sm uppercase mb-2">Checklist Saída</h4>
                                    <div class="space-y-2">
                                        <template x-for="(item, idx) in selectedTicket.checklist_final_data">
                                            <div class="flex items-center space-x-2 bg-white p-2 rounded border">
                                                 <input type="checkbox" x-model="item.ok"
                                                        :disabled="selectedTicket.status !== 'Teste Final'"
                                                        class="text-brand-600 focus:ring-brand-500 disabled:opacity-50">
                                                 <span class="text-sm" x-text="item.item"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div x-show="!selectedTicket.checklist_final_data || selectedTicket.checklist_final_data.length === 0" class="text-gray-400 text-sm italic">Vazio.</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                </template>

                <div class="bg-gray-100 px-6 py-3 flex justify-between items-center">
                    <p class="text-xs text-gray-400">ID: <span x-text="selectedTicket?.id"></span></p>
                    <div class="flex gap-3 items-center">
                        <button x-show="hasRole('admin')" @click="deleteTicket()" class="text-red-500 hover:text-red-700 font-bold text-sm flex items-center gap-1">
                            <i class="fa-solid fa-trash"></i> Excluir
                        </button>
                        <button @click="modals.viewTicket = false" class="text-gray-600 hover:text-black font-bold text-sm">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recycle Bin -->
    <div x-show="modals.recycleBin" class="fixed inset-0 z-[120] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.recycleBin = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">

                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <i class="fa-solid fa-trash-arrow-up text-brand-500"></i> Lixeira
                        </h3>
                        <button @click="modals.recycleBin = false" class="text-gray-400 hover:text-gray-500">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>

                    <div x-data="{ tab: 'tickets' }" class="mt-2">
                        <div class="flex border-b border-gray-200 mb-4">
                            <button @click="tab = 'tickets'" :class="{'border-brand-500 text-brand-600': tab === 'tickets', 'border-transparent text-gray-500 hover:text-gray-700': tab !== 'tickets'}" class="py-2 px-4 text-sm font-medium border-b-2 focus:outline-none">
                                Chamados
                            </button>
                            <button @click="tab = 'employees'" :class="{'border-brand-500 text-brand-600': tab === 'employees', 'border-transparent text-gray-500 hover:text-gray-700': tab !== 'employees'}" class="py-2 px-4 text-sm font-medium border-b-2 focus:outline-none">
                                Funcionários
                            </button>
                        </div>

                        <!-- Tickets Tab -->
                        <div x-show="tab === 'tickets'">
                            <template x-if="deletedTickets.length === 0">
                                <p class="text-gray-500 text-center py-4 text-sm">Nenhum chamado na lixeira.</p>
                            </template>
                            <ul class="divide-y divide-gray-200 max-h-[300px] overflow-y-auto">
                                <template x-for="t in deletedTickets" :key="t.id">
                                    <li class="py-3 flex justify-between items-center hover:bg-gray-50 px-2 rounded">
                                        <div>
                                            <p class="text-sm font-bold text-gray-800" x-text="'OS: ' + t.os_number"></p>
                                            <p class="text-xs text-gray-600" x-text="t.client_name + ' - ' + t.device_model"></p>
                                            <p class="text-xs text-red-500" x-text="'Excluído: ' + new Date(t.deleted_at).toLocaleDateString()"></p>
                                        </div>
                                        <button @click="restoreItem('ticket', t.id)" class="text-green-600 hover:text-green-800 text-xs font-bold border border-green-200 bg-green-50 px-3 py-1 rounded transition-colors">
                                            Restaurar
                                        </button>
                                    </li>
                                </template>
                            </ul>
                        </div>

                        <!-- Employees Tab -->
                        <div x-show="tab === 'employees'">
                            <template x-if="deletedEmployees.length === 0">
                                <p class="text-gray-500 text-center py-4 text-sm">Nenhum funcionário na lixeira.</p>
                            </template>
                            <ul class="divide-y divide-gray-200 max-h-[300px] overflow-y-auto">
                                <template x-for="e in deletedEmployees" :key="e.id">
                                    <li class="py-3 flex justify-between items-center hover:bg-gray-50 px-2 rounded">
                                        <div>
                                            <p class="text-sm font-bold text-gray-800" x-text="e.name"></p>
                                            <p class="text-xs text-gray-600" x-text="e.username"></p>
                                            <p class="text-xs text-red-500" x-text="'Excluído: ' + new Date(e.deleted_at).toLocaleDateString()"></p>
                                        </div>
                                        <button @click="restoreItem('employee', e.id)" class="text-green-600 hover:text-green-800 text-xs font-bold border border-green-200 bg-green-50 px-3 py-1 rounded transition-colors">
                                            Restaurar
                                        </button>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>

                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                     <button @click="modals.recycleBin = false" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. SHARE MODAL (New) -->
    <div x-show="showShareModal" class="fixed inset-0 z-[110] flex items-center justify-center" x-cloak>
        <div class="fixed inset-0 bg-black bg-opacity-75" @click="showShareModal = false"></div>
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm z-10 relative text-center">
            <div class="mb-4">
                 <div class="bg-brand-100 text-brand-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                     <i class="fa-solid fa-share-nodes text-xl"></i>
                 </div>
                 <h3 class="text-lg font-bold text-gray-900">Compartilhar Acompanhamento</h3>
                 <p class="text-sm text-gray-500">Envie este link para o cliente acompanhar o status.</p>
            </div>

            <div class="bg-gray-100 p-3 rounded-lg mb-4 flex items-center justify-between">
                <span class="text-xs text-gray-600 truncate mr-2" x-text="selectedTicket ? getTrackingLink(selectedTicket.id) : ''"></span>
                <button @click="copyTrackingLink()" class="text-brand-600 hover:text-brand-800 font-bold text-xs uppercase">Copiar</button>
            </div>

            <button @click="sendTrackingWhatsApp()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 flex items-center justify-center mb-2">
                <i class="fa-brands fa-whatsapp text-xl mr-2"></i> Enviar no WhatsApp
            </button>
            <button @click="showShareModal = false" class="w-full py-2 text-gray-500 font-bold text-sm hover:text-black">Fechar</button>
        </div>
    </div>

    <!-- 3. LOGS MODAL -->
    <div x-show="modals.logs" class="fixed inset-0 z-[80] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-black bg-opacity-75" @click="modals.logs = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Histórico de Atividades</h3>
                    <div class="flex items-center space-x-4">
                        <button @click="logViewMode = logViewMode === 'timeline' ? 'detailed' : 'timeline'"
                                class="text-xs font-bold uppercase tracking-wider text-brand-500 hover:text-white transition-colors border border-brand-500 px-3 py-1 rounded-full">
                            <i class="fa-solid" :class="logViewMode === 'timeline' ? 'fa-list' : 'fa-timeline'"></i>
                            <span x-text="logViewMode === 'timeline' ? 'Ver Detalhes' : 'Ver Timeline'"></span>
                        </button>
                        <button @click="modals.logs = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                </div>

                <div class="p-0 max-h-[70vh] overflow-y-auto bg-gray-50">
                     <!-- TIMELINE VIEW -->
                     <div x-show="logViewMode === 'timeline'" class="p-6 space-y-4">
                        <template x-for="log in ticketLogs.filter(l => l.user_name !== 'Sistema')" :key="log.id">
                            <div class="flex flex-col relative pl-4 border-l-2 border-gray-200 pb-4 last:border-0 last:pb-0">
                                <!-- Dot -->
                                <div class="absolute -left-[9px] top-0 h-4 w-4 rounded-full bg-brand-500 border-2 border-white"></div>

                                <!-- Content -->
                                <div class="text-sm text-gray-800">
                                    <span class="font-bold capitalize" x-text="log.action"></span>
                                    por <span class="font-bold text-gray-600" x-text="log.user_name"></span>
                                    - <span class="text-gray-500 text-xs" x-text="new Date(log.created_at).toLocaleString()"></span>
                                </div>

                                <!-- Duration Line (If present in details) -->
                                <template x-if="log.details && log.details.includes('Tempo de Reparo')">
                                    <div class="mt-1 text-sm font-bold text-brand-600 flex items-center">
                                        <i class="fa-solid fa-stopwatch mr-2"></i>
                                        <span x-text="'Reparo levou ' + log.details.split('Tempo de Reparo:')[1].trim()"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <div x-show="ticketLogs.filter(l => l.user_name !== 'Sistema').length === 0" class="text-center text-gray-400 italic">
                            Nenhuma atividade de usuário registrada.
                        </div>
                     </div>

                     <!-- DETAILED VIEW -->
                     <div x-show="logViewMode === 'detailed'">
                        <template x-for="log in ticketLogs" :key="log.id">
                            <div class="p-4 border-b border-gray-200 bg-white hover:bg-gray-50 transition-colors">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-bold text-gray-800 text-sm" x-text="log.action"></span>
                                    <span class="text-xs text-gray-500 font-mono" x-text="new Date(log.created_at).toLocaleString()"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <p class="text-sm text-gray-600 flex-grow" x-text="log.details || '-'"></p>
                                    <div class="ml-4 flex items-center">
                                        <div class="h-6 w-6 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-xs font-bold mr-2">
                                            <span x-text="(log.user_name || '?').charAt(0).toUpperCase()"></span>
                                        </div>
                                        <span class="text-xs font-bold text-gray-900" x-text="log.user_name || 'Sistema'"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                     </div>

                    <div x-show="ticketLogs.length === 0" class="p-8 text-center text-gray-500">
                        <i class="fa-solid fa-clock-rotate-left text-3xl mb-2 text-gray-300"></i>
                        <p>Nenhum registro encontrado.</p>
                    </div>
                </div>
                <div class="bg-gray-100 px-6 py-3 flex justify-end">
                     <button @click="modals.logs = false" class="text-sm font-bold text-gray-600 hover:text-black">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. CALENDAR MODAL -->
    <div x-show="modals.calendar" class="fixed inset-0 z-[90] overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" @click="modals.calendar = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-5xl sm:w-full">
                <!-- Header -->
                <div class="bg-black px-6 py-4 flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-lg font-bold text-white">Calendário de Prazos</h3>
                        <div class="flex items-center space-x-2 bg-gray-800 rounded-lg p-1">
                            <button @click="changeMonth(-1)" class="text-white hover:text-brand-500 w-8 h-8 rounded flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                            <span class="text-white font-bold w-32 text-center" x-text="currentCalendarDate.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})"></span>
                            <button @click="changeMonth(1)" class="text-white hover:text-brand-500 w-8 h-8 rounded flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <button @click="modals.calendar = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                </div>

                <!-- Body -->
                <div class="p-6 bg-gray-50">
                    <!-- Weekday Headers -->
                    <div class="grid grid-cols-7 gap-px mb-2">
                        <template x-for="day in ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb']">
                             <div class="text-center text-xs font-bold uppercase text-gray-500" x-text="day"></div>
                        </template>
                    </div>

                    <!-- Days -->
                    <div class="grid grid-cols-7 gap-2">
                        <template x-for="(day, idx) in getMonthDays()" :key="idx">
                            <div class="min-h-[120px] bg-white border border-gray-200 rounded-lg p-2 flex flex-col relative"
                                 :class="!day ? 'bg-gray-50 border-transparent' : (isSameDay(day, new Date()) ? 'border-brand-500 ring-1 ring-brand-500' : '')">

                                <template x-if="day">
                                    <div>
                                        <div class="text-right text-xs font-bold mb-2"
                                             :class="isSameDay(day, new Date()) ? 'text-brand-600' : 'text-gray-400'"
                                             x-text="day.getDate()"></div>

                                        <div class="space-y-1 overflow-y-auto max-h-[100px] scrollbar-hide">
                                            <template x-for="t in getCalendarTickets().filter(x => isSameDay(x.deadline, day))" :key="t.id">
                                                 <div class="bg-gray-50 border border-gray-100 rounded px-1.5 py-1 text-[10px] shadow-sm cursor-help hover:bg-black hover:text-white transition-colors group relative truncate" :title="t.defect_reported">
                                                     <span class="font-bold" x-text="'OS ' + t.os_number"></span>
                                                     <span x-text="t.device_model"></span>
                                                     <!-- Tooltip -->
                                                      <div class="hidden group-hover:block absolute z-50 bottom-full left-0 w-48 bg-black text-white p-2 rounded text-xs mb-1 shadow-lg pointer-events-none">
                                                         <p class="font-bold border-b border-gray-700 pb-1 mb-1" x-text="t.client_name"></p>
                                                         <p x-text="t.defect_reported"></p>
                                                     </div>
                                                 </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. OUTCOME MODAL (Success/Fail Logic) -->
    <div x-show="modals.outcome" class="fixed inset-0 z-[80] flex items-center justify-center" x-cloak>
        <div class="fixed inset-0 bg-black bg-opacity-50" @click="modals.outcome = false"></div>
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md z-10 relative">
            <h3 class="text-lg font-bold mb-4" x-text="outcomeMode === 'repair' ? 'Finalizar Reparo' : 'Concluir Testes'"></h3>

            <!-- Repair Outcome -->
            <div x-show="outcomeMode === 'repair'" class="space-y-4">
                <p class="text-gray-600">O reparo foi realizado com sucesso?</p>
                <div class="flex space-x-3">
                    <button @click="finishRepair(true)" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">
                        <i class="fa-solid fa-check mr-2"></i> Sim, Sucesso
                    </button>
                    <button @click="finishRepair(false)" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold hover:bg-red-600">
                        <i class="fa-solid fa-xmark mr-2"></i> Não, Falhou
                    </button>
                </div>
            </div>

            <!-- Test Outcome -->
            <div x-show="outcomeMode === 'test'" class="space-y-4">
                <p class="text-gray-600">O aparelho passou nos testes?</p>
                <div class="flex space-x-3 mb-4">
                    <button @click="concludeTest(true)" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">
                        <i class="fa-solid fa-check mr-2"></i> Aprovado
                    </button>
                    <button @click="showTestFailureForm = true" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold hover:bg-red-600">
                        <i class="fa-solid fa-bug mr-2"></i> Reprovado (Problema)
                    </button>
                </div>

                <div x-show="showTestFailureForm" class="bg-red-50 p-4 rounded border border-red-200" x-transition>
                    <p class="text-xs font-bold text-red-800 mb-2">Retornar para Bancada</p>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500">Novo Prazo</label>
                            <input type="datetime-local" x-model="testFailureData.newDeadline" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500">Nova Prioridade</label>
                            <select x-model="testFailureData.newPriority" class="w-full border rounded p-2 text-sm">
                                <template x-for="p in PRIORITIES"><option :value="p" x-text="p"></option></template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500">Defeito Apresentado</label>
                            <textarea x-model="testFailureData.reason" rows="2" class="w-full border rounded p-2 text-sm" placeholder="Descreva o problema encontrado..."></textarea>
                        </div>
                        <button @click="concludeTest(false)" class="w-full bg-red-800 text-white py-2 rounded font-bold hover:bg-black text-sm">Confirmar Retorno</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS MAIN -->
    <script src="js/main.js?v=5"></script>
</body>
</html>
